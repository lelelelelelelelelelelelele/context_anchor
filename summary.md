# Generated by ContextBuilder
# 项目源码分析文档 (按配置)

--- AI Interaction Instructions ---
        为您呈现的是一个项目的完整源代码快照(或部分特定项目组件的源码快照)，它采用了一种名为 "LineMark" 的系统进行精确引用。

        **LineMark 格式:**
        代码的每一行都带有一个 `[FileID:LineNumber]|` 格式的前缀。
        - `FileID`: 一个简短的标识符 (如 F1, F2)，它唯一地对应一个完整的文件路径。
        - `LineNumber`: 该行在特定文件中的行号。
        - `|`: (竖线后跟一个空格)标记与原始代码内容的分隔符。

        **您的任务:**
        在您的所有回答中，您必须使用此 LineMark 格式来引用具体的代码位置。例如:
        - "我建议重构 `[F5:23-28]` 中的逻辑。"
        - "在 `[F12:101]` 中可能存在一个潜在的bug。"
        - 若要新增代码，请这样描述: "在 `[F3:45]` 之后，插入以下代码: ..."

        这个系统确保了我们之间沟通的绝对精确性。FileID到文件路径的完整映射关系在下方的 "LineMark Manifest" 中提供。
        ---------------------------------

--- LineMark Manifest ---
F1: icon-192.png
F2: icon-512.png
F3: manifest.json
F4: manifest.webmanifest
F5: marked.min.js
F6: package-lock.json
F7: package.json
F8: plan.md
F9: README.md
F10: script.js
F11: service-worker.js
F12: sidepanel.html
F13: styles.css
F14: system_prompt.txt
F15: task_ingest_test_cases.md
F16: test.md
F17: todo.md
F18: todolist_get.txt
F19: vercel.json
F20: github/copilotrule.md
-----------------------
- 配置文件: context_config.yaml

## 项目文件结构
```
├── github/
    └── copilotrule.md
├── README.md
├── icon-192.png
├── icon-512.png
├── manifest.json
├── manifest.webmanifest
├── marked.min.js
├── package-lock.json
├── package.json
├── plan.md
├── script.js
├── service-worker.js
├── sidepanel.html
├── styles.css
├── system_prompt.txt
├── task_ingest_test_cases.md
├── test.md
├── todo.md
├── todolist_get.txt
└── vercel.json
```

## 源代码文件内容

================================================================================
文件路径: icon-192.png(F1) (约合大小: 1 KB)
================================================================================
# 错误：无法读取文件 ('utf-8' codec can't decode byte 0x89 in position 0: invalid start byte)

================================================================================
文件路径: icon-512.png(F2) (约合大小: 4 KB)
================================================================================
# 错误：无法读取文件 ('utf-8' codec can't decode byte 0x89 in position 0: invalid start byte)

================================================================================
文件路径: manifest.json(F3) (约合大小: 0 KB)
================================================================================
[F3:1]| {
[F3:2]|   "manifest_version": 3,
[F3:3]|   "name": "Rail",
[F3:4]|   "version": "0.1.0",
[F3:5]|   "description": "Context Anchor and Execution GPS for developers.",
[F3:6]|   "permissions": ["sidePanel", "activeTab", "scripting", "storage"],
[F3:7]|   "host_permissions": ["<all_urls>"],
[F3:8]|   "side_panel": {
[F3:9]|     "default_path": "sidepanel.html"
[F3:10]|   },
[F3:11]|   "action": {
[F3:12]|     "default_title": "Rail"
[F3:13]|   }
[F3:14]| }

================================================================================
文件路径: manifest.webmanifest(F4) (约合大小: 0 KB)
================================================================================
[F4:1]| {
[F4:2]|   "name": "Rail",
[F4:3]|   "short_name": "Rail",
[F4:4]|   "description": "Context Anchor and Execution GPS for developers.",
[F4:5]|   "start_url": "./",
[F4:6]|   "display": "standalone",
[F4:7]|   "background_color": "#1e1e1e",
[F4:8]|   "theme_color": "#1e1e1e",
[F4:9]|   "icons": [
[F4:10]|     {
[F4:11]|       "src": "./icon-192.png",
[F4:12]|       "sizes": "192x192",
[F4:13]|       "type": "image/png"
[F4:14]|     },
[F4:15]|     {
[F4:16]|       "src": "./icon-512.png",
[F4:17]|       "sizes": "512x512",
[F4:18]|       "type": "image/png"
[F4:19]|     }
[F4:20]|   ],
[F4:21]|   "scope": "./"
[F4:22]| }

================================================================================
文件路径: marked.min.js(F5) (约合大小: 40 KB)
================================================================================
[F5:1]| /**
[F5:2]|  * marked v17.0.1 - a markdown parser
[F5:3]|  * Copyright (c) 2018-2025, MarkedJS. (MIT License)
[F5:4]|  * Copyright (c) 2011-2018, Christopher Jeffrey. (MIT License)
[F5:5]|  * https://github.com/markedjs/marked
[F5:6]|  */
[F5:7]| 
[F5:8]| /**
[F5:9]|  * DO NOT EDIT THIS FILE
[F5:10]|  * The code in this file is generated from files in ./src/
[F5:11]|  */
[F5:12]| (function(g,f){if(typeof exports=="object"&&typeof module<"u"){module.exports=f()}else if("function"==typeof define && define.amd){define("marked",f)}else {g["marked"]=f()}}(typeof globalThis < "u" ? globalThis : typeof self < "u" ? self : this,function(){var exports={};var __exports=exports;var module={exports};
[F5:13]| "use strict";var Z=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var be=Object.getOwnPropertyNames;var Re=Object.prototype.hasOwnProperty;var Te=(l,e)=>{for(var t in e)Z(l,t,{get:e[t],enumerable:!0})},Oe=(l,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of be(e))!Re.call(l,r)&&r!==t&&Z(l,r,{get:()=>e[r],enumerable:!(n=xe(e,r))||n.enumerable});return l};var we=l=>Oe(Z({},"__esModule",{value:!0}),l);var kt={};Te(kt,{Hooks:()=>S,Lexer:()=>x,Marked:()=>A,Parser:()=>b,Renderer:()=>P,TextRenderer:()=>$,Tokenizer:()=>y,defaults:()=>T,getDefaults:()=>_,lexer:()=>ht,marked:()=>d,options:()=>it,parse:()=>pt,parseInline:()=>ut,parser:()=>ct,setOptions:()=>ot,use:()=>at,walkTokens:()=>lt});module.exports=we(kt);function _(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var T=_();function G(l){T=l}var I={exec:()=>null};function k(l,e=""){let t=typeof l=="string"?l:l.source,n={replace:(r,i)=>{let s=typeof i=="string"?i:i.source;return s=s.replace(m.caret,"$1"),t=t.replace(r,s),n},getRegex:()=>new RegExp(t,e)};return n}var ye=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),m={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:l=>new RegExp(`^( {0,3}${l})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}#`),htmlBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}<(?:[a-z].*>|!--)`,"i")},Pe=/^(?:[ \t]*(?:\n|$))+/,Se=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,$e=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,E=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,_e=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Q=/(?:[*+-]|\d{1,9}[.)])/,se=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,ie=k(se).replace(/bull/g,Q).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Le=k(se).replace(/bull/g,Q).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),F=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Me=/^[^\n]+/,j=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,ze=k(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",j).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),Ae=k(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Q).getRegex(),v="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",U=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Ce=k("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",U).replace("tag",v).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),oe=k(F).replace("hr",E).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",v).getRegex(),Ie=k(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",oe).getRegex(),K={blockquote:Ie,code:Se,def:ze,fences:$e,heading:_e,hr:E,html:Ce,lheading:ie,list:Ae,newline:Pe,paragraph:oe,table:I,text:Me},ne=k("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",E).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",v).getRegex(),Ee={...K,lheading:Le,table:ne,paragraph:k(F).replace("hr",E).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",ne).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",v).getRegex()},Be={...K,html:k(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",U).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:I,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:k(F).replace("hr",E).replace("heading",` *#{1,6} *[^
[F5:14]| ]`).replace("lheading",ie).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},qe=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,ve=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,ae=/^( {2,}|\\)\n(?!\s*$)/,De=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,D=/[\p{P}\p{S}]/u,W=/[\s\p{P}\p{S}]/u,le=/[^\s\p{P}\p{S}]/u,He=k(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,W).getRegex(),ue=/(?!~)[\p{P}\p{S}]/u,Ze=/(?!~)[\s\p{P}\p{S}]/u,Ge=/(?:[^\s\p{P}\p{S}]|~)/u,Ne=k(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",ye?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),pe=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,Qe=k(pe,"u").replace(/punct/g,D).getRegex(),Fe=k(pe,"u").replace(/punct/g,ue).getRegex(),ce="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",je=k(ce,"gu").replace(/notPunctSpace/g,le).replace(/punctSpace/g,W).replace(/punct/g,D).getRegex(),Ue=k(ce,"gu").replace(/notPunctSpace/g,Ge).replace(/punctSpace/g,Ze).replace(/punct/g,ue).getRegex(),Ke=k("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,le).replace(/punctSpace/g,W).replace(/punct/g,D).getRegex(),We=k(/\\(punct)/,"gu").replace(/punct/g,D).getRegex(),Xe=k(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Je=k(U).replace("(?:-->|$)","-->").getRegex(),Ve=k("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Je).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),q=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,Ye=k(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",q).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),he=k(/^!?\[(label)\]\[(ref)\]/).replace("label",q).replace("ref",j).getRegex(),ke=k(/^!?\[(ref)\](?:\[\])?/).replace("ref",j).getRegex(),et=k("reflink|nolink(?!\\()","g").replace("reflink",he).replace("nolink",ke).getRegex(),re=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,X={_backpedal:I,anyPunctuation:We,autolink:Xe,blockSkip:Ne,br:ae,code:ve,del:I,emStrongLDelim:Qe,emStrongRDelimAst:je,emStrongRDelimUnd:Ke,escape:qe,link:Ye,nolink:ke,punctuation:He,reflink:he,reflinkSearch:et,tag:Ve,text:De,url:I},tt={...X,link:k(/^!?\[(label)\]\((.*?)\)/).replace("label",q).getRegex(),reflink:k(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",q).getRegex()},N={...X,emStrongRDelimAst:Ue,emStrongLDelim:Fe,url:k(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",re).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:k(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",re).getRegex()},nt={...N,br:k(ae).replace("{2,}","*").getRegex(),text:k(N.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},B={normal:K,gfm:Ee,pedantic:Be},M={normal:X,gfm:N,breaks:nt,pedantic:tt};var rt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},de=l=>rt[l];function w(l,e){if(e){if(m.escapeTest.test(l))return l.replace(m.escapeReplace,de)}else if(m.escapeTestNoEncode.test(l))return l.replace(m.escapeReplaceNoEncode,de);return l}function J(l){try{l=encodeURI(l).replace(m.percentDecode,"%")}catch{return null}return l}function V(l,e){let t=l.replace(m.findPipe,(i,s,a)=>{let o=!1,u=s;for(;--u>=0&&a[u]==="\\";)o=!o;return o?"|":" |"}),n=t.split(m.splitPipe),r=0;if(n[0].trim()||n.shift(),n.length>0&&!n.at(-1)?.trim()&&n.pop(),e)if(n.length>e)n.splice(e);else for(;n.length<e;)n.push("");for(;r<n.length;r++)n[r]=n[r].trim().replace(m.slashPipe,"|");return n}function z(l,e,t){let n=l.length;if(n===0)return"";let r=0;for(;r<n;){let i=l.charAt(n-r-1);if(i===e&&!t)r++;else if(i!==e&&t)r++;else break}return l.slice(0,n-r)}function ge(l,e){if(l.indexOf(e[1])===-1)return-1;let t=0;for(let n=0;n<l.length;n++)if(l[n]==="\\")n++;else if(l[n]===e[0])t++;else if(l[n]===e[1]&&(t--,t<0))return n;return t>0?-2:-1}function fe(l,e,t,n,r){let i=e.href,s=e.title||null,a=l[1].replace(r.other.outputLinkReplace,"$1");n.state.inLink=!0;let o={type:l[0].charAt(0)==="!"?"image":"link",raw:t,href:i,title:s,text:a,tokens:n.inlineTokens(a)};return n.state.inLink=!1,o}function st(l,e,t){let n=l.match(t.other.indentCodeCompensation);if(n===null)return e;let r=n[1];return e.split(`
[F5:15]| `).map(i=>{let s=i.match(t.other.beginningSpace);if(s===null)return i;let[a]=s;return a.length>=r.length?i.slice(r.length):i}).join(`
[F5:16]| `)}var y=class{options;rules;lexer;constructor(e){this.options=e||T}space(e){let t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){let t=this.rules.block.code.exec(e);if(t){let n=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?n:z(n,`
[F5:17]| `)}}}fences(e){let t=this.rules.block.fences.exec(e);if(t){let n=t[0],r=st(n,t[3]||"",this.rules);return{type:"code",raw:n,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:r}}}heading(e){let t=this.rules.block.heading.exec(e);if(t){let n=t[2].trim();if(this.rules.other.endingHash.test(n)){let r=z(n,"#");(this.options.pedantic||!r||this.rules.other.endingSpaceChar.test(r))&&(n=r.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:n,tokens:this.lexer.inline(n)}}}hr(e){let t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:z(t[0],`
[F5:18]| `)}}blockquote(e){let t=this.rules.block.blockquote.exec(e);if(t){let n=z(t[0],`
[F5:19]| `).split(`
[F5:20]| `),r="",i="",s=[];for(;n.length>0;){let a=!1,o=[],u;for(u=0;u<n.length;u++)if(this.rules.other.blockquoteStart.test(n[u]))o.push(n[u]),a=!0;else if(!a)o.push(n[u]);else break;n=n.slice(u);let p=o.join(`
[F5:21]| `),c=p.replace(this.rules.other.blockquoteSetextReplace,`
[F5:22]|     $1`).replace(this.rules.other.blockquoteSetextReplace2,"");r=r?`${r}
[F5:23]| ${p}`:p,i=i?`${i}
[F5:24]| ${c}`:c;let g=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(c,s,!0),this.lexer.state.top=g,n.length===0)break;let h=s.at(-1);if(h?.type==="code")break;if(h?.type==="blockquote"){let R=h,f=R.raw+`
[F5:25]| `+n.join(`
[F5:26]| `),O=this.blockquote(f);s[s.length-1]=O,r=r.substring(0,r.length-R.raw.length)+O.raw,i=i.substring(0,i.length-R.text.length)+O.text;break}else if(h?.type==="list"){let R=h,f=R.raw+`
[F5:27]| `+n.join(`
[F5:28]| `),O=this.list(f);s[s.length-1]=O,r=r.substring(0,r.length-h.raw.length)+O.raw,i=i.substring(0,i.length-R.raw.length)+O.raw,n=f.substring(s.at(-1).raw.length).split(`
[F5:29]| `);continue}}return{type:"blockquote",raw:r,tokens:s,text:i}}}list(e){let t=this.rules.block.list.exec(e);if(t){let n=t[1].trim(),r=n.length>1,i={type:"list",raw:"",ordered:r,start:r?+n.slice(0,-1):"",loose:!1,items:[]};n=r?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=r?n:"[*+-]");let s=this.rules.other.listItemRegex(n),a=!1;for(;e;){let u=!1,p="",c="";if(!(t=s.exec(e))||this.rules.block.hr.test(e))break;p=t[0],e=e.substring(p.length);let g=t[2].split(`
[F5:30]| `,1)[0].replace(this.rules.other.listReplaceTabs,O=>" ".repeat(3*O.length)),h=e.split(`
[F5:31]| `,1)[0],R=!g.trim(),f=0;if(this.options.pedantic?(f=2,c=g.trimStart()):R?f=t[1].length+1:(f=t[2].search(this.rules.other.nonSpaceChar),f=f>4?1:f,c=g.slice(f),f+=t[1].length),R&&this.rules.other.blankLine.test(h)&&(p+=h+`
[F5:32]| `,e=e.substring(h.length+1),u=!0),!u){let O=this.rules.other.nextBulletRegex(f),Y=this.rules.other.hrRegex(f),ee=this.rules.other.fencesBeginRegex(f),te=this.rules.other.headingBeginRegex(f),me=this.rules.other.htmlBeginRegex(f);for(;e;){let H=e.split(`
[F5:33]| `,1)[0],C;if(h=H,this.options.pedantic?(h=h.replace(this.rules.other.listReplaceNesting,"  "),C=h):C=h.replace(this.rules.other.tabCharGlobal,"    "),ee.test(h)||te.test(h)||me.test(h)||O.test(h)||Y.test(h))break;if(C.search(this.rules.other.nonSpaceChar)>=f||!h.trim())c+=`
[F5:34]| `+C.slice(f);else{if(R||g.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||ee.test(g)||te.test(g)||Y.test(g))break;c+=`
[F5:35]| `+h}!R&&!h.trim()&&(R=!0),p+=H+`
[F5:36]| `,e=e.substring(H.length+1),g=C.slice(f)}}i.loose||(a?i.loose=!0:this.rules.other.doubleBlankLine.test(p)&&(a=!0)),i.items.push({type:"list_item",raw:p,task:!!this.options.gfm&&this.rules.other.listIsTask.test(c),loose:!1,text:c,tokens:[]}),i.raw+=p}let o=i.items.at(-1);if(o)o.raw=o.raw.trimEnd(),o.text=o.text.trimEnd();else return;i.raw=i.raw.trimEnd();for(let u of i.items){if(this.lexer.state.top=!1,u.tokens=this.lexer.blockTokens(u.text,[]),u.task){if(u.text=u.text.replace(this.rules.other.listReplaceTask,""),u.tokens[0]?.type==="text"||u.tokens[0]?.type==="paragraph"){u.tokens[0].raw=u.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),u.tokens[0].text=u.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let c=this.lexer.inlineQueue.length-1;c>=0;c--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[c].src)){this.lexer.inlineQueue[c].src=this.lexer.inlineQueue[c].src.replace(this.rules.other.listReplaceTask,"");break}}let p=this.rules.other.listTaskCheckbox.exec(u.raw);if(p){let c={type:"checkbox",raw:p[0]+" ",checked:p[0]!=="[ ]"};u.checked=c.checked,i.loose?u.tokens[0]&&["paragraph","text"].includes(u.tokens[0].type)&&"tokens"in u.tokens[0]&&u.tokens[0].tokens?(u.tokens[0].raw=c.raw+u.tokens[0].raw,u.tokens[0].text=c.raw+u.tokens[0].text,u.tokens[0].tokens.unshift(c)):u.tokens.unshift({type:"paragraph",raw:c.raw,text:c.raw,tokens:[c]}):u.tokens.unshift(c)}}if(!i.loose){let p=u.tokens.filter(g=>g.type==="space"),c=p.length>0&&p.some(g=>this.rules.other.anyLine.test(g.raw));i.loose=c}}if(i.loose)for(let u of i.items){u.loose=!0;for(let p of u.tokens)p.type==="text"&&(p.type="paragraph")}return i}}html(e){let t=this.rules.block.html.exec(e);if(t)return{type:"html",block:!0,raw:t[0],pre:t[1]==="pre"||t[1]==="script"||t[1]==="style",text:t[0]}}def(e){let t=this.rules.block.def.exec(e);if(t){let n=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),r=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",i=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:n,raw:t[0],href:r,title:i}}}table(e){let t=this.rules.block.table.exec(e);if(!t||!this.rules.other.tableDelimiter.test(t[2]))return;let n=V(t[1]),r=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),i=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split(`
[F5:37]| `):[],s={type:"table",raw:t[0],header:[],align:[],rows:[]};if(n.length===r.length){for(let a of r)this.rules.other.tableAlignRight.test(a)?s.align.push("right"):this.rules.other.tableAlignCenter.test(a)?s.align.push("center"):this.rules.other.tableAlignLeft.test(a)?s.align.push("left"):s.align.push(null);for(let a=0;a<n.length;a++)s.header.push({text:n[a],tokens:this.lexer.inline(n[a]),header:!0,align:s.align[a]});for(let a of i)s.rows.push(V(a,s.header.length).map((o,u)=>({text:o,tokens:this.lexer.inline(o),header:!1,align:s.align[u]})));return s}}lheading(e){let t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:t[2].charAt(0)==="="?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){let t=this.rules.block.paragraph.exec(e);if(t){let n=t[1].charAt(t[1].length-1)===`
[F5:38]| `?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:n,tokens:this.lexer.inline(n)}}}text(e){let t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){let t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(e){let t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(e){let t=this.rules.inline.link.exec(e);if(t){let n=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(n)){if(!this.rules.other.endAngleBracket.test(n))return;let s=z(n.slice(0,-1),"\\");if((n.length-s.length)%2===0)return}else{let s=ge(t[2],"()");if(s===-2)return;if(s>-1){let o=(t[0].indexOf("!")===0?5:4)+t[1].length+s;t[2]=t[2].substring(0,s),t[0]=t[0].substring(0,o).trim(),t[3]=""}}let r=t[2],i="";if(this.options.pedantic){let s=this.rules.other.pedanticHrefTitle.exec(r);s&&(r=s[1],i=s[3])}else i=t[3]?t[3].slice(1,-1):"";return r=r.trim(),this.rules.other.startAngleBracket.test(r)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(n)?r=r.slice(1):r=r.slice(1,-1)),fe(t,{href:r&&r.replace(this.rules.inline.anyPunctuation,"$1"),title:i&&i.replace(this.rules.inline.anyPunctuation,"$1")},t[0],this.lexer,this.rules)}}reflink(e,t){let n;if((n=this.rules.inline.reflink.exec(e))||(n=this.rules.inline.nolink.exec(e))){let r=(n[2]||n[1]).replace(this.rules.other.multipleSpaceGlobal," "),i=t[r.toLowerCase()];if(!i){let s=n[0].charAt(0);return{type:"text",raw:s,text:s}}return fe(n,i,n[0],this.lexer,this.rules)}}emStrong(e,t,n=""){let r=this.rules.inline.emStrongLDelim.exec(e);if(!r||r[3]&&n.match(this.rules.other.unicodeAlphaNumeric))return;if(!(r[1]||r[2]||"")||!n||this.rules.inline.punctuation.exec(n)){let s=[...r[0]].length-1,a,o,u=s,p=0,c=r[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,t=t.slice(-1*e.length+s);(r=c.exec(t))!=null;){if(a=r[1]||r[2]||r[3]||r[4]||r[5]||r[6],!a)continue;if(o=[...a].length,r[3]||r[4]){u+=o;continue}else if((r[5]||r[6])&&s%3&&!((s+o)%3)){p+=o;continue}if(u-=o,u>0)continue;o=Math.min(o,o+u+p);let g=[...r[0]][0].length,h=e.slice(0,s+r.index+g+o);if(Math.min(s,o)%2){let f=h.slice(1,-1);return{type:"em",raw:h,text:f,tokens:this.lexer.inlineTokens(f)}}let R=h.slice(2,-2);return{type:"strong",raw:h,text:R,tokens:this.lexer.inlineTokens(R)}}}}codespan(e){let t=this.rules.inline.code.exec(e);if(t){let n=t[2].replace(this.rules.other.newLineCharGlobal," "),r=this.rules.other.nonSpaceChar.test(n),i=this.rules.other.startingSpaceChar.test(n)&&this.rules.other.endingSpaceChar.test(n);return r&&i&&(n=n.substring(1,n.length-1)),{type:"codespan",raw:t[0],text:n}}}br(e){let t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){let t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e){let t=this.rules.inline.autolink.exec(e);if(t){let n,r;return t[2]==="@"?(n=t[1],r="mailto:"+n):(n=t[1],r=n),{type:"link",raw:t[0],text:n,href:r,tokens:[{type:"text",raw:n,text:n}]}}}url(e){let t;if(t=this.rules.inline.url.exec(e)){let n,r;if(t[2]==="@")n=t[0],r="mailto:"+n;else{let i;do i=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??"";while(i!==t[0]);n=t[0],t[1]==="www."?r="http://"+t[0]:r=t[0]}return{type:"link",raw:t[0],text:n,href:r,tokens:[{type:"text",raw:n,text:n}]}}}inlineText(e){let t=this.rules.inline.text.exec(e);if(t){let n=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:n}}}};var x=class l{tokens;options;state;inlineQueue;tokenizer;constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||T,this.options.tokenizer=this.options.tokenizer||new y,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:m,block:B.normal,inline:M.normal};this.options.pedantic?(t.block=B.pedantic,t.inline=M.pedantic):this.options.gfm&&(t.block=B.gfm,this.options.breaks?t.inline=M.breaks:t.inline=M.gfm),this.tokenizer.rules=t}static get rules(){return{block:B,inline:M}}static lex(e,t){return new l(t).lex(e)}static lexInline(e,t){return new l(t).inlineTokens(e)}lex(e){e=e.replace(m.carriageReturn,`
[F5:39]| `),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let n=this.inlineQueue[t];this.inlineTokens(n.src,n.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){for(this.options.pedantic&&(e=e.replace(m.tabCharGlobal,"    ").replace(m.spaceLine,""));e;){let r;if(this.options.extensions?.block?.some(s=>(r=s.call({lexer:this},e,t))?(e=e.substring(r.raw.length),t.push(r),!0):!1))continue;if(r=this.tokenizer.space(e)){e=e.substring(r.raw.length);let s=t.at(-1);r.raw.length===1&&s!==void 0?s.raw+=`
[F5:40]| `:t.push(r);continue}if(r=this.tokenizer.code(e)){e=e.substring(r.raw.length);let s=t.at(-1);s?.type==="paragraph"||s?.type==="text"?(s.raw+=(s.raw.endsWith(`
[F5:41]| `)?"":`
[F5:42]| `)+r.raw,s.text+=`
[F5:43]| `+r.text,this.inlineQueue.at(-1).src=s.text):t.push(r);continue}if(r=this.tokenizer.fences(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.heading(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.hr(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.blockquote(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.list(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.html(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.def(e)){e=e.substring(r.raw.length);let s=t.at(-1);s?.type==="paragraph"||s?.type==="text"?(s.raw+=(s.raw.endsWith(`
[F5:44]| `)?"":`
[F5:45]| `)+r.raw,s.text+=`
[F5:46]| `+r.raw,this.inlineQueue.at(-1).src=s.text):this.tokens.links[r.tag]||(this.tokens.links[r.tag]={href:r.href,title:r.title},t.push(r));continue}if(r=this.tokenizer.table(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.lheading(e)){e=e.substring(r.raw.length),t.push(r);continue}let i=e;if(this.options.extensions?.startBlock){let s=1/0,a=e.slice(1),o;this.options.extensions.startBlock.forEach(u=>{o=u.call({lexer:this},a),typeof o=="number"&&o>=0&&(s=Math.min(s,o))}),s<1/0&&s>=0&&(i=e.substring(0,s+1))}if(this.state.top&&(r=this.tokenizer.paragraph(i))){let s=t.at(-1);n&&s?.type==="paragraph"?(s.raw+=(s.raw.endsWith(`
[F5:47]| `)?"":`
[F5:48]| `)+r.raw,s.text+=`
[F5:49]| `+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=s.text):t.push(r),n=i.length!==e.length,e=e.substring(r.raw.length);continue}if(r=this.tokenizer.text(e)){e=e.substring(r.raw.length);let s=t.at(-1);s?.type==="text"?(s.raw+=(s.raw.endsWith(`
[F5:50]| `)?"":`
[F5:51]| `)+r.raw,s.text+=`
[F5:52]| `+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=s.text):t.push(r);continue}if(e){let s="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(s);break}else throw new Error(s)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n=e,r=null;if(this.tokens.links){let o=Object.keys(this.tokens.links);if(o.length>0)for(;(r=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)o.includes(r[0].slice(r[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(r=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,r.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let i;for(;(r=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)i=r[2]?r[2].length:0,n=n.slice(0,r.index+i)+"["+"a".repeat(r[0].length-i-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);n=this.options.hooks?.emStrongMask?.call({lexer:this},n)??n;let s=!1,a="";for(;e;){s||(a=""),s=!1;let o;if(this.options.extensions?.inline?.some(p=>(o=p.call({lexer:this},e,t))?(e=e.substring(o.raw.length),t.push(o),!0):!1))continue;if(o=this.tokenizer.escape(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.tag(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.link(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(o.raw.length);let p=t.at(-1);o.type==="text"&&p?.type==="text"?(p.raw+=o.raw,p.text+=o.text):t.push(o);continue}if(o=this.tokenizer.emStrong(e,n,a)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.codespan(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.br(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.del(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.autolink(e)){e=e.substring(o.raw.length),t.push(o);continue}if(!this.state.inLink&&(o=this.tokenizer.url(e))){e=e.substring(o.raw.length),t.push(o);continue}let u=e;if(this.options.extensions?.startInline){let p=1/0,c=e.slice(1),g;this.options.extensions.startInline.forEach(h=>{g=h.call({lexer:this},c),typeof g=="number"&&g>=0&&(p=Math.min(p,g))}),p<1/0&&p>=0&&(u=e.substring(0,p+1))}if(o=this.tokenizer.inlineText(u)){e=e.substring(o.raw.length),o.raw.slice(-1)!=="_"&&(a=o.raw.slice(-1)),s=!0;let p=t.at(-1);p?.type==="text"?(p.raw+=o.raw,p.text+=o.text):t.push(o);continue}if(e){let p="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(p);break}else throw new Error(p)}}return t}};var P=class{options;parser;constructor(e){this.options=e||T}space(e){return""}code({text:e,lang:t,escaped:n}){let r=(t||"").match(m.notSpaceStart)?.[0],i=e.replace(m.endingNewline,"")+`
[F5:53]| `;return r?'<pre><code class="language-'+w(r)+'">'+(n?i:w(i,!0))+`</code></pre>
[F5:54]| `:"<pre><code>"+(n?i:w(i,!0))+`</code></pre>
[F5:55]| `}blockquote({tokens:e}){return`<blockquote>
[F5:56]| ${this.parser.parse(e)}</blockquote>
[F5:57]| `}html({text:e}){return e}def(e){return""}heading({tokens:e,depth:t}){return`<h${t}>${this.parser.parseInline(e)}</h${t}>
[F5:58]| `}hr(e){return`<hr>
[F5:59]| `}list(e){let t=e.ordered,n=e.start,r="";for(let a=0;a<e.items.length;a++){let o=e.items[a];r+=this.listitem(o)}let i=t?"ol":"ul",s=t&&n!==1?' start="'+n+'"':"";return"<"+i+s+`>
[F5:60]| `+r+"</"+i+`>
[F5:61]| `}listitem(e){return`<li>${this.parser.parse(e.tokens)}</li>
[F5:62]| `}checkbox({checked:e}){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:e}){return`<p>${this.parser.parseInline(e)}</p>
[F5:63]| `}table(e){let t="",n="";for(let i=0;i<e.header.length;i++)n+=this.tablecell(e.header[i]);t+=this.tablerow({text:n});let r="";for(let i=0;i<e.rows.length;i++){let s=e.rows[i];n="";for(let a=0;a<s.length;a++)n+=this.tablecell(s[a]);r+=this.tablerow({text:n})}return r&&(r=`<tbody>${r}</tbody>`),`<table>
[F5:64]| <thead>
[F5:65]| `+t+`</thead>
[F5:66]| `+r+`</table>
[F5:67]| `}tablerow({text:e}){return`<tr>
[F5:68]| ${e}</tr>
[F5:69]| `}tablecell(e){let t=this.parser.parseInline(e.tokens),n=e.header?"th":"td";return(e.align?`<${n} align="${e.align}">`:`<${n}>`)+t+`</${n}>
[F5:70]| `}strong({tokens:e}){return`<strong>${this.parser.parseInline(e)}</strong>`}em({tokens:e}){return`<em>${this.parser.parseInline(e)}</em>`}codespan({text:e}){return`<code>${w(e,!0)}</code>`}br(e){return"<br>"}del({tokens:e}){return`<del>${this.parser.parseInline(e)}</del>`}link({href:e,title:t,tokens:n}){let r=this.parser.parseInline(n),i=J(e);if(i===null)return r;e=i;let s='<a href="'+e+'"';return t&&(s+=' title="'+w(t)+'"'),s+=">"+r+"</a>",s}image({href:e,title:t,text:n,tokens:r}){r&&(n=this.parser.parseInline(r,this.parser.textRenderer));let i=J(e);if(i===null)return w(n);e=i;let s=`<img src="${e}" alt="${n}"`;return t&&(s+=` title="${w(t)}"`),s+=">",s}text(e){return"tokens"in e&&e.tokens?this.parser.parseInline(e.tokens):"escaped"in e&&e.escaped?e.text:w(e.text)}};var $=class{strong({text:e}){return e}em({text:e}){return e}codespan({text:e}){return e}del({text:e}){return e}html({text:e}){return e}text({text:e}){return e}link({text:e}){return""+e}image({text:e}){return""+e}br(){return""}checkbox({raw:e}){return e}};var b=class l{options;renderer;textRenderer;constructor(e){this.options=e||T,this.options.renderer=this.options.renderer||new P,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new $}static parse(e,t){return new l(t).parse(e)}static parseInline(e,t){return new l(t).parseInline(e)}parse(e){let t="";for(let n=0;n<e.length;n++){let r=e[n];if(this.options.extensions?.renderers?.[r.type]){let s=r,a=this.options.extensions.renderers[s.type].call({parser:this},s);if(a!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(s.type)){t+=a||"";continue}}let i=r;switch(i.type){case"space":{t+=this.renderer.space(i);break}case"hr":{t+=this.renderer.hr(i);break}case"heading":{t+=this.renderer.heading(i);break}case"code":{t+=this.renderer.code(i);break}case"table":{t+=this.renderer.table(i);break}case"blockquote":{t+=this.renderer.blockquote(i);break}case"list":{t+=this.renderer.list(i);break}case"checkbox":{t+=this.renderer.checkbox(i);break}case"html":{t+=this.renderer.html(i);break}case"def":{t+=this.renderer.def(i);break}case"paragraph":{t+=this.renderer.paragraph(i);break}case"text":{t+=this.renderer.text(i);break}default:{let s='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(s),"";throw new Error(s)}}}return t}parseInline(e,t=this.renderer){let n="";for(let r=0;r<e.length;r++){let i=e[r];if(this.options.extensions?.renderers?.[i.type]){let a=this.options.extensions.renderers[i.type].call({parser:this},i);if(a!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(i.type)){n+=a||"";continue}}let s=i;switch(s.type){case"escape":{n+=t.text(s);break}case"html":{n+=t.html(s);break}case"link":{n+=t.link(s);break}case"image":{n+=t.image(s);break}case"checkbox":{n+=t.checkbox(s);break}case"strong":{n+=t.strong(s);break}case"em":{n+=t.em(s);break}case"codespan":{n+=t.codespan(s);break}case"br":{n+=t.br(s);break}case"del":{n+=t.del(s);break}case"text":{n+=t.text(s);break}default:{let a='Token with "'+s.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw new Error(a)}}}return n}};var S=class{options;block;constructor(e){this.options=e||T}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens","emStrongMask"]);static passThroughHooksRespectAsync=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(e){return e}postprocess(e){return e}processAllTokens(e){return e}emStrongMask(e){return e}provideLexer(){return this.block?x.lex:x.lexInline}provideParser(){return this.block?b.parse:b.parseInline}};var A=class{defaults=_();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=b;Renderer=P;TextRenderer=$;Lexer=x;Tokenizer=y;Hooks=S;constructor(...e){this.use(...e)}walkTokens(e,t){let n=[];for(let r of e)switch(n=n.concat(t.call(this,r)),r.type){case"table":{let i=r;for(let s of i.header)n=n.concat(this.walkTokens(s.tokens,t));for(let s of i.rows)for(let a of s)n=n.concat(this.walkTokens(a.tokens,t));break}case"list":{let i=r;n=n.concat(this.walkTokens(i.items,t));break}default:{let i=r;this.defaults.extensions?.childTokens?.[i.type]?this.defaults.extensions.childTokens[i.type].forEach(s=>{let a=i[s].flat(1/0);n=n.concat(this.walkTokens(a,t))}):i.tokens&&(n=n.concat(this.walkTokens(i.tokens,t)))}}return n}use(...e){let t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach(n=>{let r={...n};if(r.async=this.defaults.async||r.async||!1,n.extensions&&(n.extensions.forEach(i=>{if(!i.name)throw new Error("extension name required");if("renderer"in i){let s=t.renderers[i.name];s?t.renderers[i.name]=function(...a){let o=i.renderer.apply(this,a);return o===!1&&(o=s.apply(this,a)),o}:t.renderers[i.name]=i.renderer}if("tokenizer"in i){if(!i.level||i.level!=="block"&&i.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let s=t[i.level];s?s.unshift(i.tokenizer):t[i.level]=[i.tokenizer],i.start&&(i.level==="block"?t.startBlock?t.startBlock.push(i.start):t.startBlock=[i.start]:i.level==="inline"&&(t.startInline?t.startInline.push(i.start):t.startInline=[i.start]))}"childTokens"in i&&i.childTokens&&(t.childTokens[i.name]=i.childTokens)}),r.extensions=t),n.renderer){let i=this.defaults.renderer||new P(this.defaults);for(let s in n.renderer){if(!(s in i))throw new Error(`renderer '${s}' does not exist`);if(["options","parser"].includes(s))continue;let a=s,o=n.renderer[a],u=i[a];i[a]=(...p)=>{let c=o.apply(i,p);return c===!1&&(c=u.apply(i,p)),c||""}}r.renderer=i}if(n.tokenizer){let i=this.defaults.tokenizer||new y(this.defaults);for(let s in n.tokenizer){if(!(s in i))throw new Error(`tokenizer '${s}' does not exist`);if(["options","rules","lexer"].includes(s))continue;let a=s,o=n.tokenizer[a],u=i[a];i[a]=(...p)=>{let c=o.apply(i,p);return c===!1&&(c=u.apply(i,p)),c}}r.tokenizer=i}if(n.hooks){let i=this.defaults.hooks||new S;for(let s in n.hooks){if(!(s in i))throw new Error(`hook '${s}' does not exist`);if(["options","block"].includes(s))continue;let a=s,o=n.hooks[a],u=i[a];S.passThroughHooks.has(s)?i[a]=p=>{if(this.defaults.async&&S.passThroughHooksRespectAsync.has(s))return(async()=>{let g=await o.call(i,p);return u.call(i,g)})();let c=o.call(i,p);return u.call(i,c)}:i[a]=(...p)=>{if(this.defaults.async)return(async()=>{let g=await o.apply(i,p);return g===!1&&(g=await u.apply(i,p)),g})();let c=o.apply(i,p);return c===!1&&(c=u.apply(i,p)),c}}r.hooks=i}if(n.walkTokens){let i=this.defaults.walkTokens,s=n.walkTokens;r.walkTokens=function(a){let o=[];return o.push(s.call(this,a)),i&&(o=o.concat(i.call(this,a))),o}}this.defaults={...this.defaults,...r}}),this}setOptions(e){return this.defaults={...this.defaults,...e},this}lexer(e,t){return x.lex(e,t??this.defaults)}parser(e,t){return b.parse(e,t??this.defaults)}parseMarkdown(e){return(n,r)=>{let i={...r},s={...this.defaults,...i},a=this.onError(!!s.silent,!!s.async);if(this.defaults.async===!0&&i.async===!1)return a(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof n>"u"||n===null)return a(new Error("marked(): input parameter is undefined or null"));if(typeof n!="string")return a(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(n)+", string expected"));if(s.hooks&&(s.hooks.options=s,s.hooks.block=e),s.async)return(async()=>{let o=s.hooks?await s.hooks.preprocess(n):n,p=await(s.hooks?await s.hooks.provideLexer():e?x.lex:x.lexInline)(o,s),c=s.hooks?await s.hooks.processAllTokens(p):p;s.walkTokens&&await Promise.all(this.walkTokens(c,s.walkTokens));let h=await(s.hooks?await s.hooks.provideParser():e?b.parse:b.parseInline)(c,s);return s.hooks?await s.hooks.postprocess(h):h})().catch(a);try{s.hooks&&(n=s.hooks.preprocess(n));let u=(s.hooks?s.hooks.provideLexer():e?x.lex:x.lexInline)(n,s);s.hooks&&(u=s.hooks.processAllTokens(u)),s.walkTokens&&this.walkTokens(u,s.walkTokens);let c=(s.hooks?s.hooks.provideParser():e?b.parse:b.parseInline)(u,s);return s.hooks&&(c=s.hooks.postprocess(c)),c}catch(o){return a(o)}}}onError(e,t){return n=>{if(n.message+=`
[F5:71]| Please report this to https://github.com/markedjs/marked.`,e){let r="<p>An error occurred:</p><pre>"+w(n.message+"",!0)+"</pre>";return t?Promise.resolve(r):r}if(t)return Promise.reject(n);throw n}}};var L=new A;function d(l,e){return L.parse(l,e)}d.options=d.setOptions=function(l){return L.setOptions(l),d.defaults=L.defaults,G(d.defaults),d};d.getDefaults=_;d.defaults=T;d.use=function(...l){return L.use(...l),d.defaults=L.defaults,G(d.defaults),d};d.walkTokens=function(l,e){return L.walkTokens(l,e)};d.parseInline=L.parseInline;d.Parser=b;d.parser=b.parse;d.Renderer=P;d.TextRenderer=$;d.Lexer=x;d.lexer=x.lex;d.Tokenizer=y;d.Hooks=S;d.parse=d;var it=d.options,ot=d.setOptions,at=d.use,lt=d.walkTokens,ut=d.parseInline,pt=d,ct=b.parse,ht=x.lex;
[F5:72]| 
[F5:73]| if(__exports != exports)module.exports = exports;return module.exports}));
[F5:74]| //# sourceMappingURL=marked.umd.js.map

================================================================================
文件路径: package-lock.json(F6) (约合大小: 0 KB)
================================================================================
[F6:1]| {
[F6:2]|   "name": "context_anchor",
[F6:3]|   "version": "1.0.0",
[F6:4]|   "lockfileVersion": 3,
[F6:5]|   "requires": true,
[F6:6]|   "packages": {
[F6:7]|     "": {
[F6:8]|       "name": "context_anchor",
[F6:9]|       "version": "1.0.0",
[F6:10]|       "license": "ISC",
[F6:11]|       "dependencies": {
[F6:12]|         "marked": "^17.0.1"
[F6:13]|       }
[F6:14]|     },
[F6:15]|     "node_modules/marked": {
[F6:16]|       "version": "17.0.1",
[F6:17]|       "resolved": "https://registry.npmjs.org/marked/-/marked-17.0.1.tgz",
[F6:18]|       "integrity": "sha512-boeBdiS0ghpWcSwoNm/jJBwdpFaMnZWRzjA6SkUMYb40SVaN1x7mmfGKp0jvexGcx+7y2La5zRZsYFZI6Qpypg==",
[F6:19]|       "license": "MIT",
[F6:20]|       "bin": {
[F6:21]|         "marked": "bin/marked.js"
[F6:22]|       },
[F6:23]|       "engines": {
[F6:24]|         "node": ">= 20"
[F6:25]|       }
[F6:26]|     }
[F6:27]|   }
[F6:28]| }

================================================================================
文件路径: package.json(F7) (约合大小: 0 KB)
================================================================================
[F7:1]| {
[F7:2]|   "name": "context_anchor",
[F7:3]|   "version": "1.0.0",
[F7:4]|   "description": "Minimalist, local-first side panel for task anchoring and execution chat.",
[F7:5]|   "main": "script.js",
[F7:6]|   "scripts": {
[F7:7]|     "test": "echo \"Error: no test specified\" && exit 1"
[F7:8]|   },
[F7:9]|   "repository": {
[F7:10]|     "type": "git",
[F7:11]|     "url": "git+https://github.com/lelelelelelelelelelelelele/context_anchor.git"
[F7:12]|   },
[F7:13]|   "keywords": [],
[F7:14]|   "author": "",
[F7:15]|   "license": "ISC",
[F7:16]|   "bugs": {
[F7:17]|     "url": "https://github.com/lelelelelelelelelelelelele/context_anchor/issues"
[F7:18]|   },
[F7:19]|   "homepage": "https://github.com/lelelelelelelelelelelelele/context_anchor#readme",
[F7:20]|   "dependencies": {
[F7:21]|     "marked": "^17.0.1"
[F7:22]|   }
[F7:23]| }

================================================================================
文件路径: plan.md(F8) (约合大小: 0 KB)
================================================================================
[F8:1]| # do in the future(not now)
[F8:2]| *   **流式传输 (Streaming) 缺失**:
[F8:3]|     *   在 `sendChat` `[F5:470]` 中使用了 `await fetch` 等待完整返回。对于较长的 AI 回复，界面会卡在 "Thinking..." 状态较久。
[F8:4]|     *   **建议**: 未来可以引入 `ReadableStream` 来实现打字机效果。
[F8:5]| 
[F8:6]| 1.  **UI 反馈增强**:
[F8:7]|     在 `[F8:113-116]` 的 `.task-item.active` 样式中，可以增加一个微弱的脉动动画（Pulse），视觉上强调这是当前的 "Execution GPS" 焦点。
[F8:8]| 2.  **快捷键绑定**:
[F8:9]|     在 `[F5:514]` 的 `keydown` 监听中，建议增加 `Ctrl+Enter` 发送消息，并增加一个快捷键用于快速勾选当前任务为 Done。

================================================================================
文件路径: README.md(F9) (约合大小: 4 KB)
================================================================================
[F9:1]| # Rail (Extension + PWA)
[F9:2]| 
[F9:3]| Minimalist, local-first side panel for task anchoring and execution chat.
[F9:4]| 
[F9:5]| ## Features
[F9:6]| - **Local-first tasks**: Tasks and settings persist in local storage.
[F9:7]| - **AI chat with context**: Injects active task, details, and progress into prompts.
[F9:8]| - **Streaming responses**: SSE + typewriter rendering for fast feedback.
[F9:9]| - **AI Convert**: Turn raw text into Rail tasks with `todolist_get.txt`.
[F9:10]| - **Layouts**: Split, Inline, and Nano modes with active-step focus.
[F9:11]| - **Nano markers**: `[ SOURCE ]` / `[ DESTINATION ]` boundary hints.
[F9:12]| - **Markdown details**: Rendered via local `marked.min.js` with sanitization.
[F9:13]| - **Code copy**: One-click copy buttons on code blocks.
[F9:14]| - **PWA-ready**: Installable when hosted with service worker + manifest.
[F9:15]| 
[F9:16]| ## Files
[F9:17]| - `manifest.json`: Chrome Extension Manifest V3.
[F9:18]| - `sidepanel.html`: UI layout (60% tasks, 40% chat).
[F9:19]| - `styles.css`: VS Code-like dark theme.
[F9:20]| - `script.js`: Task list, settings, and chat logic.
[F9:21]| 
[F9:22]| ## Quick Test (Browser)
[F9:23]| 1. Open `sidepanel.html` directly in a browser.
[F9:24]| 2. Paste steps using the Markdown format below and click **Add Tasks**.
[F9:25]| 3. Save API settings and send a chat question.
[F9:26]| 
[F9:27]| ## Task Format (Markdown)
[F9:28]| Rail ingests tasks from Markdown headings.
[F9:29]| 
[F9:30]| - `### Step title` defines a step (becomes a task).
[F9:31]| - Indented continuation lines under a step become step details (stored in `context_payload.details`).
[F9:32]| - `#` (document title) and `##` (group title) are reserved for future expansion.
[F9:33]| 
[F9:34]| Example:
[F9:35]| 
[F9:36]| ```md
[F9:37]| # Project Title (optional)
[F9:38]| ## Phase A (optional)
[F9:39]| 
[F9:40]| ### Implement parser
[F9:41]| 	Accept only ### headings as steps.
[F9:42]| 	Indented lines become details.
[F9:43]| 
[F9:44]| ### Update docs
[F9:45]| 	Document the format in README.
[F9:46]| ```
[F9:47]| 
[F9:48]| Notes:
[F9:49]| - Lines that are not `###` steps (and not indented details under a step) are ignored.
[F9:50]| - The previous "one line = one task" format is intentionally not supported.
[F9:51]| 
[F9:52]| ## Load in Chrome (Extension)
[F9:53]| 1. Open `chrome://extensions/`.
[F9:54]| 2. Enable **Developer mode**.
[F9:55]| 3. Click **Load unpacked** and select the `github` folder.
[F9:56]| 4. Open the side panel from the extension toolbar.
[F9:57]| 
[F9:58]| ## Run as PWA (Local)
[F9:59]| 1. Start a local static server at the project root.
[F9:60]| 2. Open the served `sidepanel.html` in a browser.
[F9:61]| 3. Use the install icon to add it as an app (optional).
[F9:62]| 
[F9:63]| ## Markdown Rendering (marked.js)
[F9:64]| Rail uses a local `marked.min.js` (no CDN) to render task details + chat bubbles as Markdown.
[F9:65]| 
[F9:66]| Setup (one-time):
[F9:67]| 1. Install the dependency:
[F9:68]| 	- `npm i marked`
[F9:69]| 2. Copy the browser (UMD) build into the project root:
[F9:70]| 	- `copy node_modules\marked\lib\marked.umd.js marked.min.js`
[F9:71]| 
[F9:72]| Notes:
[F9:73]| - The filename must be exactly `marked.min.js` (it is referenced by `sidepanel.html`).
[F9:74]| - Service Worker caching only works when served over `http://` / `https://` (not `file://`).
[F9:75]| 
[F9:76]| ## Manual Test Plan
[F9:77]| - **Task ingestion**: Paste multi-line text → multiple tasks appear.
[F9:78]| - **Toggle active/done**: Click tasks to mark done; active task is highlighted.
[F9:79]| - **Progress indicator**: Verify bottom status shows `done/total 完成` and updates on toggle.
[F9:80]| - **Persistence**: Refresh panel → tasks and settings remain.
[F9:81]| - **API validation**: Remove API key → sending chat alerts.
[F9:82]| - **Context injection**: Active task, totals, and pending list appear in prompt (inspect via server logs if using a proxy).
[F9:83]| - **Providers**: Add multiple providers, switch dropdown, and verify settings change.
[F9:84]| 
[F9:85]| ## Keyboard Shortcuts
[F9:86]| - `Enter`: Send chat message (when focused in the chat input).
[F9:87]| - `Alt + Enter`: Toggle chat drawer open/close; focuses input when opening.
[F9:88]| - `Alt + D`: Mark active task as done and move to next pending.
[F9:89]| - `Alt + N`: Toggle task layout between Inline and Nano.
[F9:90]| 
[F9:91]| ## System Prompt Template
[F9:92]| The system prompt lives in `system_prompt.txt`. You can edit it directly and use these placeholders:
[F9:93]| - `{ACTIVE_TASK}`: Current active task text.
[F9:94]| - `{TASK_DETAILS}`: Markdown details for the active task (or "(no details)").
[F9:95]| - `{TOTAL_TASKS}`: Number of tasks in the list.
[F9:96]| - `{DONE_TASKS}`: Count of completed tasks.
[F9:97]| - `{PENDING_TASKS}`: Bullet list of pending tasks (or "All tasks completed!").

================================================================================
文件路径: script.js(F10) (约合大小: 44 KB)
================================================================================
[F10:1]| const TASKS_KEY = "rail_tasks";
[F10:2]| const ACTIVE_TASK_KEY = "rail_active_task_id";
[F10:3]| const PROVIDERS_KEY = "rail_providers";
[F10:4]| const ACTIVE_PROVIDER_INDEX = "rail_current_provider_idx";
[F10:5]| const LAYOUT_MODE_KEY = "rail_layout_mode";
[F10:6]| const TEMP_CHAT_KEY = "rail_temp_chat";
[F10:7]| const DEFAULT_BASE_URL = "https://api.openai.com";
[F10:8]| const DEFAULT_MODEL = "gpt-4o-mini";
[F10:9]| const PROMPT_PATH = "system_prompt.txt";
[F10:10]| const TODOLIST_PROMPT_PATH = "todolist_get.txt";
[F10:11]| const ENABLE_DECOMPOSE = false;
[F10:12]| const DEFAULT_SYSTEM_PROMPT_TEMPLATE = `You are Rail, a developer's Execution GPS.
[F10:13]| 
[F10:14]| [MACRO GOAL / PROGRESS]
[F10:15]| Total tasks in project: {TOTAL_TASKS}
[F10:16]| Completed: {DONE_TASKS}/{TOTAL_TASKS}
[F10:17]| 
[F10:18]| [NEXT STEPS IN PIPELINE]
[F10:19]| {PENDING_TASKS}
[F10:20]| 
[F10:21]| [CURRENT FOCUS (CRITICAL)]
[F10:22]| The user is currently working on: "{ACTIVE_TASK}"
[F10:23]| Task details (Markdown):
[F10:24]| {TASK_DETAILS}
[F10:25]| 
[F10:26]| [INSTRUCTION]
[F10:27]| 1. Your answers MUST align with the Current Focus.
[F10:28]| 2. Use the Macro Goal and Next Steps only as background context to ensure consistency.
[F10:29]| 3. Be a minimalist. Give high-density, low-fluff code.`;
[F10:30]| const DEFAULT_TODOLIST_PROMPT_TEMPLATE = `You are a Rail task-ingest format converter.
[F10:31]| 
[F10:32]| [FORMAT]
[F10:33]| - Use only: # (optional title), ## (optional group), ### (task).
[F10:34]| - Details must be indented lines under a ### task.
[F10:35]| - Never output lines starting with ### inside details.
[F10:36]| - Keep all commands/paths/ports verbatim in details; do not summarize.
[F10:37]| - If input is not a todo list, output exactly: NOT_A_TODOLIST
[F10:38]| 
[F10:39]| <<<INPUT
[F10:40]| (paste input here)
[F10:41]| INPUT
[F10:42]| 
[F10:43]| Output only the converted Rail Markdown.`;
[F10:44]| 
[F10:45]| let tasks = [];
[F10:46]| let activeTaskId = null;
[F10:47]| let chatHistory = [];
[F10:48]| let systemPromptTemplate = DEFAULT_SYSTEM_PROMPT_TEMPLATE;
[F10:49]| let todolistPromptTemplate = null;
[F10:50]| let providers = [];
[F10:51]| let currentProviderIdx = 0;
[F10:52]| let layoutMode = "split";
[F10:53]| let chatCollapsed = true;
[F10:54]| 
[F10:55]| const taskInput = document.getElementById("task-input");
[F10:56]| const addTasksButton = document.getElementById("add-tasks");
[F10:57]| const aiConvertToggle = document.getElementById("ai-convert");
[F10:58]| const overviewTasksButton = document.getElementById("overview-tasks");
[F10:59]| const clearTasksButton = document.getElementById("clear-tasks");
[F10:60]| const taskList = document.getElementById("task-list");
[F10:61]| const taskDocTitle = document.getElementById("task-doc-title");
[F10:62]| const taskDetailsPanel = document.getElementById("task-details");
[F10:63]| const taskDetailsStep = document.getElementById("task-details-step");
[F10:64]| const taskDetailsMeta = document.getElementById("task-details-meta");
[F10:65]| const taskDetailsBody = document.getElementById("task-details-body");
[F10:66]| const taskProgress = document.getElementById("task-progress");
[F10:67]| const chatMessages = document.getElementById("chat-messages");
[F10:68]| const chatStatus = document.getElementById("chat-status");
[F10:69]| const chatInput = document.getElementById("chat-input");
[F10:70]| const sendChatButton = document.getElementById("send-chat");
[F10:71]| const clearChatButton = document.getElementById("clear-chat");
[F10:72]| const chatDrawerToggle = document.getElementById("chat-drawer-toggle");
[F10:73]| 
[F10:74]| // Page navigation
[F10:75]| const mainPage = document.getElementById("main-page");
[F10:76]| const editorPage = document.getElementById("editor-page");
[F10:77]| const settingsPage = document.getElementById("settings-page");
[F10:78]| 
[F10:79]| const addTaskToggle = document.getElementById("add-task-toggle");
[F10:80]| const editorBackButton = document.getElementById("editor-back");
[F10:81]| const openSettingsButton = document.getElementById("open-settings");
[F10:82]| const settingsBackButton = document.getElementById("settings-back");
[F10:83]| 
[F10:84]| const progressBarFill = document.getElementById("progress-bar-fill");
[F10:85]| 
[F10:86]| // Settings page controls
[F10:87]| const providersList = document.getElementById("providers-list");
[F10:88]| const providerNewButton = document.getElementById("provider-new");
[F10:89]| const providerNameInput = document.getElementById("provider-name");
[F10:90]| const providerKeyInput = document.getElementById("provider-key");
[F10:91]| const providerUrlInput = document.getElementById("provider-url");
[F10:92]| const providerModelInput = document.getElementById("provider-model");
[F10:93]| const providerSaveButton = document.getElementById("provider-save");
[F10:94]| const providerDeleteButton = document.getElementById("provider-delete");
[F10:95]| const layoutModeSelect = document.getElementById("layout-mode");
[F10:96]| 
[F10:97]| let markedConfigured = false;
[F10:98]| 
[F10:99]| function setAddTasksLoading(isLoading, label = "Add Tasks") {
[F10:100]|   if (!addTasksButton) {
[F10:101]|     return;
[F10:102]|   }
[F10:103]|   addTasksButton.disabled = Boolean(isLoading);
[F10:104]|   addTasksButton.textContent = isLoading ? "Converting..." : label;
[F10:105]| }
[F10:106]| 
[F10:107]| function escapeHtml(text) {
[F10:108]|   return String(text)
[F10:109]|     .replaceAll("&", "&amp;")
[F10:110]|     .replaceAll("<", "&lt;")
[F10:111]|     .replaceAll(">", "&gt;")
[F10:112]|     .replaceAll('"', "&quot;")
[F10:113]|     .replaceAll("'", "&#39;");
[F10:114]| }
[F10:115]| 
[F10:116]| function configureMarkedOnce() {
[F10:117]|   if (markedConfigured) {
[F10:118]|     return;
[F10:119]|   }
[F10:120]|   const markedApi = typeof window !== "undefined" ? window.marked : null;
[F10:121]|   if (!markedApi || typeof markedApi.setOptions !== "function") {
[F10:122]|     return;
[F10:123]|   }
[F10:124]| 
[F10:125]|   // Security: we still sanitize output below; these options mostly improve UX.
[F10:126]|   markedApi.setOptions({
[F10:127]|     breaks: true,
[F10:128]|     gfm: true,
[F10:129]|     headerIds: false,
[F10:130]|     mangle: false,
[F10:131]|   });
[F10:132]|   markedConfigured = true;
[F10:133]| }
[F10:134]| 
[F10:135]| function sanitizeRenderedHtml(unsafeHtml) {
[F10:136]|   const template = document.createElement("template");
[F10:137]|   template.innerHTML = String(unsafeHtml || "");
[F10:138]| 
[F10:139]|   const blockedTags = new Set([
[F10:140]|     "script",
[F10:141]|     "style",
[F10:142]|     "iframe",
[F10:143]|     "object",
[F10:144]|     "embed",
[F10:145]|     "link",
[F10:146]|     "meta",
[F10:147]|   ]);
[F10:148]| 
[F10:149]|   const allowedProtocols = new Set(["http:", "https:", "mailto:"]);
[F10:150]| 
[F10:151]|   const walker = document.createTreeWalker(template.content, NodeFilter.SHOW_ELEMENT);
[F10:152]|   const elements = [];
[F10:153]|   while (walker.nextNode()) {
[F10:154]|     elements.push(walker.currentNode);
[F10:155]|   }
[F10:156]| 
[F10:157]|   for (const el of elements) {
[F10:158]|     const tagName = el.tagName ? el.tagName.toLowerCase() : "";
[F10:159]|     if (blockedTags.has(tagName)) {
[F10:160]|       el.remove();
[F10:161]|       continue;
[F10:162]|     }
[F10:163]| 
[F10:164]|     for (const attr of Array.from(el.attributes || [])) {
[F10:165]|       const name = attr.name.toLowerCase();
[F10:166]|       const value = attr.value;
[F10:167]| 
[F10:168]|       if (name.startsWith("on") || name === "style") {
[F10:169]|         el.removeAttribute(attr.name);
[F10:170]|         continue;
[F10:171]|       }
[F10:172]| 
[F10:173]|       if (name === "href" || name === "src") {
[F10:174]|         const trimmed = String(value || "").trim();
[F10:175]|         if (!trimmed) {
[F10:176]|           continue;
[F10:177]|         }
[F10:178]| 
[F10:179]|         // Allow in-page anchors and relative URLs.
[F10:180]|         if (trimmed.startsWith("#") || trimmed.startsWith("/") || trimmed.startsWith(".")) {
[F10:181]|           continue;
[F10:182]|         }
[F10:183]| 
[F10:184]|         try {
[F10:185]|           const parsed = new URL(trimmed, window.location.href);
[F10:186]|           if (!allowedProtocols.has(parsed.protocol)) {
[F10:187]|             el.removeAttribute(attr.name);
[F10:188]|           }
[F10:189]|         } catch (error) {
[F10:190]|           el.removeAttribute(attr.name);
[F10:191]|         }
[F10:192]|       }
[F10:193]|     }
[F10:194]|   }
[F10:195]| 
[F10:196]|   return template.innerHTML;
[F10:197]| }
[F10:198]| 
[F10:199]| function renderMarkdownToSafeHtml(markdownText) {
[F10:200]|   const source = String(markdownText || "");
[F10:201]|   const markedApi = typeof window !== "undefined" ? window.marked : null;
[F10:202]|   if (!markedApi || typeof markedApi.parse !== "function") {
[F10:203]|     // Fallback: escape and preserve line breaks.
[F10:204]|     return escapeHtml(source).replaceAll("\n", "<br>");
[F10:205]|   }
[F10:206]| 
[F10:207]|   configureMarkedOnce();
[F10:208]|   const rendered = markedApi.parse(source);
[F10:209]|   return sanitizeRenderedHtml(rendered);
[F10:210]| }
[F10:211]| 
[F10:212]| async function copyTextToClipboard(text) {
[F10:213]|   const payload = text || "";
[F10:214]|   if (!payload) {
[F10:215]|     return false;
[F10:216]|   }
[F10:217]|   try {
[F10:218]|     if (navigator.clipboard?.writeText) {
[F10:219]|       await navigator.clipboard.writeText(payload);
[F10:220]|       return true;
[F10:221]|     }
[F10:222]|   } catch (error) {
[F10:223]|     // Fallback below.
[F10:224]|   }
[F10:225]| 
[F10:226]|   try {
[F10:227]|     const textarea = document.createElement("textarea");
[F10:228]|     textarea.value = payload;
[F10:229]|     textarea.style.position = "fixed";
[F10:230]|     textarea.style.opacity = "0";
[F10:231]|     document.body.appendChild(textarea);
[F10:232]|     textarea.focus();
[F10:233]|     textarea.select();
[F10:234]|     const success = document.execCommand("copy");
[F10:235]|     document.body.removeChild(textarea);
[F10:236]|     return success;
[F10:237]|   } catch (error) {
[F10:238]|     return false;
[F10:239]|   }
[F10:240]| }
[F10:241]| 
[F10:242]| function enhanceCodeBlocks(container) {
[F10:243]|   if (!container) {
[F10:244]|     return;
[F10:245]|   }
[F10:246]|   const blocks = container.querySelectorAll("pre");
[F10:247]|   blocks.forEach((block) => {
[F10:248]|     if (block.dataset.copyReady === "true") {
[F10:249]|       return;
[F10:250]|     }
[F10:251]|     block.dataset.copyReady = "true";
[F10:252]|     block.classList.add("code-block");
[F10:253]| 
[F10:254]|     const button = document.createElement("button");
[F10:255]|     button.type = "button";
[F10:256]|     button.className = "copy-code";
[F10:257]|     button.textContent = "Copy";
[F10:258]|     button.addEventListener("click", async (event) => {
[F10:259]|       event.stopPropagation();
[F10:260]|       const code = block.querySelector("code");
[F10:261]|       const text = code ? code.textContent : block.textContent;
[F10:262]|       const success = await copyTextToClipboard(text);
[F10:263]|       button.textContent = success ? "Copied" : "Copy failed";
[F10:264]|       setTimeout(() => {
[F10:265]|         button.textContent = "Copy";
[F10:266]|       }, 1200);
[F10:267]|     });
[F10:268]| 
[F10:269]|     block.appendChild(button);
[F10:270]|   });
[F10:271]| }
[F10:272]| 
[F10:273]| function persistLayoutMode() {
[F10:274]|   localStorage.setItem(LAYOUT_MODE_KEY, layoutMode);
[F10:275]| }
[F10:276]| 
[F10:277]| function applyLayoutMode() {
[F10:278]|   if (!document.body) {
[F10:279]|     return;
[F10:280]|   }
[F10:281]|   document.body.classList.toggle("layout-inline", layoutMode === "inline");
[F10:282]|   document.body.classList.toggle("layout-nano", layoutMode === "nano");
[F10:283]| }
[F10:284]| 
[F10:285]| function toggleInlineNanoLayout() {
[F10:286]|   if (layoutMode === "nano") {
[F10:287]|     layoutMode = "inline";
[F10:288]|   } else if (layoutMode === "inline") {
[F10:289]|     layoutMode = "nano";
[F10:290]|   } else {
[F10:291]|     layoutMode = "inline";
[F10:292]|   }
[F10:293]|   if (layoutModeSelect) {
[F10:294]|     layoutModeSelect.value = layoutMode;
[F10:295]|   }
[F10:296]|   persistLayoutMode();
[F10:297]|   ensureActiveTaskSelection();
[F10:298]|   renderTasks();
[F10:299]| }
[F10:300]| 
[F10:301]| function markActiveTaskDoneAndNext() {
[F10:302]|   if (!activeTaskId) {
[F10:303]|     return;
[F10:304]|   }
[F10:305]|   const task = tasks.find((item) => item.id === activeTaskId);
[F10:306]|   if (!task) {
[F10:307]|     return;
[F10:308]|   }
[F10:309]|   if (task.status !== "done") {
[F10:310]|     task.status = "done";
[F10:311]|   }
[F10:312]|   const nextPending = tasks.find((item) => item.status === "pending");
[F10:313]|   activeTaskId = nextPending ? nextPending.id : null;
[F10:314]|   saveTasks();
[F10:315]|   renderTasks();
[F10:316]| }
[F10:317]| 
[F10:318]| function setChatCollapsed(nextCollapsed) {
[F10:319]|   chatCollapsed = Boolean(nextCollapsed);
[F10:320]|   if (document.body) {
[F10:321]|     document.body.classList.toggle("chat-collapsed", chatCollapsed);
[F10:322]|   }
[F10:323]|   if (chatDrawerToggle) {
[F10:324]|     chatDrawerToggle.textContent = chatCollapsed ? "▼" : "▲";
[F10:325]|     chatDrawerToggle.setAttribute("aria-expanded", chatCollapsed ? "false" : "true");
[F10:326]|   }
[F10:327]| }
[F10:328]| 
[F10:329]| function openEditorPage() {
[F10:330]|   if (mainPage) mainPage.classList.add("hidden");
[F10:331]|   if (settingsPage) settingsPage.classList.add("hidden");
[F10:332]|   if (editorPage) editorPage.classList.remove("hidden");
[F10:333]|   
[F10:334]|   if (taskInput) {
[F10:335]|     // Fill with current tasks as Markdown
[F10:336]|     const currentMd = tasksToMarkdown(tasks);
[F10:337]|     taskInput.value = currentMd;
[F10:338]|     taskInput.focus();
[F10:339]|     // Move cursor to end
[F10:340]|     taskInput.setSelectionRange(currentMd.length, currentMd.length);
[F10:341]|   }
[F10:342]| }
[F10:343]| 
[F10:344]| function closeEditorPage() {
[F10:345]|   if (editorPage) editorPage.classList.add("hidden");
[F10:346]|   if (mainPage) mainPage.classList.remove("hidden");
[F10:347]| }
[F10:348]| 
[F10:349]| function openSettingsPage() {
[F10:350]|   if (mainPage) {
[F10:351]|     mainPage.classList.add("hidden");
[F10:352]|   }
[F10:353]|   if (settingsPage) {
[F10:354]|     settingsPage.classList.remove("hidden");
[F10:355]|   }
[F10:356]|   renderProvidersList();
[F10:357]|   fillProviderForm();
[F10:358]|   if (layoutModeSelect) {
[F10:359]|     layoutModeSelect.value = layoutMode;
[F10:360]|   }
[F10:361]| }
[F10:362]| 
[F10:363]| function openMainPage() {
[F10:364]|   if (settingsPage) {
[F10:365]|     settingsPage.classList.add("hidden");
[F10:366]|   }
[F10:367]|   if (editorPage) {
[F10:368]|     editorPage.classList.add("hidden");
[F10:369]|   }
[F10:370]|   if (mainPage) {
[F10:371]|     mainPage.classList.remove("hidden");
[F10:372]|   }
[F10:373]| }
[F10:374]| 
[F10:375]| function loadTasks() {
[F10:376]|   try {
[F10:377]|     const raw = localStorage.getItem(TASKS_KEY);
[F10:378]|     tasks = raw ? JSON.parse(raw) : [];
[F10:379]|   } catch (error) {
[F10:380]|     tasks = [];
[F10:381]|   }
[F10:382]| 
[F10:383]|   const storedActive = localStorage.getItem(ACTIVE_TASK_KEY);
[F10:384]|   activeTaskId = storedActive ? Number(storedActive) : null;
[F10:385]| 
[F10:386]|   if (!tasks.find((task) => task.id === activeTaskId)) {
[F10:387]|     activeTaskId = null;
[F10:388]|   }
[F10:389]| 
[F10:390]|   const cachedChat = localStorage.getItem(TEMP_CHAT_KEY);
[F10:391]|   if (cachedChat) {
[F10:392]|     try {
[F10:393]|       const parsed = JSON.parse(cachedChat);
[F10:394]|       if (Array.isArray(parsed)) {
[F10:395]|         chatHistory = parsed;
[F10:396]|       }
[F10:397]|     } catch (error) {
[F10:398]|       chatHistory = [];
[F10:399]|     }
[F10:400]|   }
[F10:401]| }
[F10:402]| 
[F10:403]| function ensureActiveTaskSelection() {
[F10:404]|   if (activeTaskId && tasks.find((task) => task.id === activeTaskId)) {
[F10:405]|     return;
[F10:406]|   }
[F10:407]| 
[F10:408]|   if (layoutMode === "nano") {
[F10:409]|     activeTaskId = null;
[F10:410]|     return;
[F10:411]|   }
[F10:412]| 
[F10:413]|   const firstPending = tasks.find((task) => task.status === "pending");
[F10:414]|   activeTaskId = firstPending ? firstPending.id : null;
[F10:415]|   saveTasks();
[F10:416]| }
[F10:417]| 
[F10:418]| function saveTasks() {
[F10:419]|   localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
[F10:420]|   if (activeTaskId) {
[F10:421]|     localStorage.setItem(ACTIVE_TASK_KEY, String(activeTaskId));
[F10:422]|   } else {
[F10:423]|     localStorage.removeItem(ACTIVE_TASK_KEY);
[F10:424]|   }
[F10:425]| }
[F10:426]| 
[F10:427]| function getActiveTask() {
[F10:428]|   if (!activeTaskId) {
[F10:429]|     return null;
[F10:430]|   }
[F10:431]|   return tasks.find((task) => task.id === activeTaskId) || null;
[F10:432]| }
[F10:433]| 
[F10:434]| function getActiveTaskMeta(task) {
[F10:435]|   const payload = task?.context_payload || {};
[F10:436]|   const documentTitle = payload.document_title || null;
[F10:437]|   const groupTitle = payload.group_title || null;
[F10:438]|   const details = payload.details || "";
[F10:439]|   return { documentTitle, groupTitle, details };
[F10:440]| }
[F10:441]| 
[F10:442]| function renderActiveTaskDetails() {
[F10:443]|   applyLayoutMode();
[F10:444]| 
[F10:445]|   const activeTask = getActiveTask();
[F10:446]|   const { documentTitle, groupTitle, details } = getActiveTaskMeta(activeTask);
[F10:447]| 
[F10:448]|   if (taskDocTitle) {
[F10:449]|     taskDocTitle.textContent = documentTitle ? `# ${documentTitle}` : "";
[F10:450]|   }
[F10:451]| 
[F10:452]|   if (!taskDetailsPanel || layoutMode !== "split") {
[F10:453]|     return;
[F10:454]|   }
[F10:455]| 
[F10:456]|   if (!activeTask) {
[F10:457]|     taskDetailsStep.textContent = "No active step";
[F10:458]|     taskDetailsMeta.textContent = "";
[F10:459]|     taskDetailsBody.textContent = "Select a step to view details.";
[F10:460]|     return;
[F10:461]|   }
[F10:462]| 
[F10:463]|   taskDetailsStep.textContent = activeTask.text;
[F10:464]|   taskDetailsMeta.textContent = groupTitle ? `## ${groupTitle}` : "";
[F10:465]|   taskDetailsBody.innerHTML = renderMarkdownToSafeHtml(details || "(no details)");
[F10:466]|   enhanceCodeBlocks(taskDetailsBody);
[F10:467]| }
[F10:468]| 
[F10:469]| function createTaskDetailsSnippet(task) {
[F10:470]|   const { documentTitle, groupTitle, details } = getActiveTaskMeta(task);
[F10:471]|   const container = document.createDocumentFragment();
[F10:472]| 
[F10:473]|   const metaParts = [];
[F10:474]|   if (documentTitle) metaParts.push(`# ${documentTitle}`);
[F10:475]|   if (groupTitle) metaParts.push(`## ${groupTitle}`);
[F10:476]| 
[F10:477]|   if (metaParts.length > 0) {
[F10:478]|     const meta = document.createElement("div");
[F10:479]|     meta.className = "task-inline-meta";
[F10:480]|     meta.textContent = metaParts.join(" · ");
[F10:481]|     container.appendChild(meta);
[F10:482]|   }
[F10:483]| 
[F10:484]|   const body = document.createElement("div");
[F10:485]|   body.className = "task-inline-details md";
[F10:486]|   body.innerHTML = renderMarkdownToSafeHtml(details || "(no details)");
[F10:487]|   enhanceCodeBlocks(body);
[F10:488]|   container.appendChild(body);
[F10:489]| 
[F10:490]|   return container;
[F10:491]| }
[F10:492]| 
[F10:493]| function createTaskItem(task, options = {}) {
[F10:494]|   const { isActive, isSecondary } = options;
[F10:495]|   const item = document.createElement("div");
[F10:496]|   item.className = "task-item";
[F10:497]|   if (task.status === "done") item.classList.add("done");
[F10:498]|   if (isActive) item.classList.add("active");
[F10:499]|   if (isSecondary) item.classList.add("nano-secondary");
[F10:500]|   item.dataset.id = String(task.id);
[F10:501]| 
[F10:502]|   const row = document.createElement("div");
[F10:503]|   row.className = "task-item-row";
[F10:504]| 
[F10:505]|   const text = document.createElement("span");
[F10:506]|   text.textContent = task.text;
[F10:507]| 
[F10:508]|   const status = document.createElement("span");
[F10:509]|   status.className = "task-status";
[F10:510]|   status.textContent = task.status === "done" ? "Done" : "Active";
[F10:511]| 
[F10:512]|   row.appendChild(text);
[F10:513]|   row.appendChild(status);
[F10:514]| 
[F10:515]|   if (ENABLE_DECOMPOSE) {
[F10:516]|     const decomposeButton = document.createElement("button");
[F10:517]|     decomposeButton.className = "decompose-btn";
[F10:518]|     decomposeButton.type = "button";
[F10:519]|     decomposeButton.textContent = "Decompose";
[F10:520]|     decomposeButton.addEventListener("click", (event) => {
[F10:521]|       event.stopPropagation();
[F10:522]|       decomposeTask(task.id, decomposeButton);
[F10:523]|     });
[F10:524]|     row.appendChild(decomposeButton);
[F10:525]|   }
[F10:526]|   item.appendChild(row);
[F10:527]| 
[F10:528]|   // Inline/Nano details
[F10:529]|   if (isActive && (layoutMode === "inline" || layoutMode === "nano")) {
[F10:530]|     item.classList.add("with-details");
[F10:531]|     item.appendChild(createTaskDetailsSnippet(task));
[F10:532]|   }
[F10:533]| 
[F10:534]|   item.addEventListener("click", (event) => {
[F10:535]|     if (window.getSelection().toString().length > 0) return;
[F10:536]|     if (event.target.closest(".copy-code") || event.target.closest("pre") || event.target.closest("code")) return;
[F10:537]|     if (ENABLE_DECOMPOSE && event.target.closest(".decompose-btn")) return;
[F10:538]|     toggleTask(task.id);
[F10:539]|   });
[F10:540]| 
[F10:541]|   return item;
[F10:542]| }
[F10:543]| 
[F10:544]| function renderTasks() {
[F10:545]|   taskList.innerHTML = "";
[F10:546]| 
[F10:547]|   renderActiveTaskDetails();
[F10:548]| 
[F10:549]|   if (taskProgress) {
[F10:550]|     const totalTasks = tasks.length;
[F10:551]|     const doneTasks = tasks.filter((task) => task.status === "done").length;
[F10:552]|     taskProgress.textContent = `${doneTasks}/${totalTasks} 完成`;
[F10:553]| 
[F10:554]|     if (progressBarFill) {
[F10:555]|       const percentage = totalTasks > 0 ? (doneTasks / totalTasks) * 100 : 0;
[F10:556]|       progressBarFill.style.width = `${percentage}%`;
[F10:557]|     }
[F10:558]|   }
[F10:559]| 
[F10:560]|   if (tasks.length === 0) {
[F10:561]|     const empty = document.createElement("div");
[F10:562]|     empty.className = "task-status";
[F10:563]|     empty.textContent = "No tasks yet. Paste a list to begin.";
[F10:564]|     taskList.appendChild(empty);
[F10:565]|     renderActiveTaskDetails();
[F10:566]|     return;
[F10:567]|   }
[F10:568]| 
[F10:569]|   let tasksToRender = tasks;
[F10:570]|   let activeIdx = -1;
[F10:571]|   const isNanoMode = layoutMode === "nano";
[F10:572]|   if (isNanoMode && activeTaskId) {
[F10:573]|     activeIdx = tasks.findIndex((t) => t.id === activeTaskId);
[F10:574]|     if (activeIdx >= 0) {
[F10:575]|       const start = Math.max(0, activeIdx - 1);
[F10:576]|       const end = Math.min(tasks.length, activeIdx + 2);
[F10:577]|       tasksToRender = tasks.slice(start, end);
[F10:578]|     }
[F10:579]|   }
[F10:580]| 
[F10:581]|   if (document.body) {
[F10:582]|     document.body.classList.toggle("nano-view", isNanoMode && activeIdx >= 0);
[F10:583]|   }
[F10:584]| 
[F10:585]|   if (isNanoMode && activeIdx >= 0) {
[F10:586]|     if (activeIdx === 0) {
[F10:587]|       const marker = document.createElement("div");
[F10:588]|       marker.className = "nano-marker";
[F10:589]|       marker.textContent = "[ SOURCE ]";
[F10:590]|       taskList.appendChild(marker);
[F10:591]|     }
[F10:592]|   }
[F10:593]| 
[F10:594]|   tasksToRender.forEach((task) => {
[F10:595]|     const isActive = task.id === activeTaskId;
[F10:596]|     const isSecondary = isNanoMode && activeIdx >= 0 && !isActive;
[F10:597]|     const item = createTaskItem(task, { isActive, isSecondary });
[F10:598]|     taskList.appendChild(item);
[F10:599]|   });
[F10:600]| 
[F10:601]|   if (isNanoMode && activeIdx >= 0) {
[F10:602]|     if (activeIdx === tasks.length - 1) {
[F10:603]|       const marker = document.createElement("div");
[F10:604]|       marker.className = "nano-marker";
[F10:605]|       marker.textContent = "[ DESTINATION ]";
[F10:606]|       taskList.appendChild(marker);
[F10:607]|     }
[F10:608]|   }
[F10:609]| 
[F10:610]|   renderActiveTaskDetails();
[F10:611]| }
[F10:612]| 
[F10:613]| function toggleTask(taskId) {
[F10:614]|   const task = tasks.find((item) => item.id === taskId);
[F10:615]|   if (!task) {
[F10:616]|     return;
[F10:617]|   }
[F10:618]| 
[F10:619]|   const switchingTask = activeTaskId && taskId !== activeTaskId;
[F10:620]|   if (switchingTask) {
[F10:621]|     clearChatContext();
[F10:622]|   }
[F10:623]| 
[F10:624]|   if (taskId !== activeTaskId) {
[F10:625]|     activeTaskId = task.id;
[F10:626]|     if (task.status === "done") {
[F10:627]|       task.status = "pending";
[F10:628]|     }
[F10:629]|   } else {
[F10:630]|     task.status = task.status === "done" ? "pending" : "done";
[F10:631]|     if (task.status === "done") {
[F10:632]|       const nextPending = tasks.find((item) => item.status === "pending");
[F10:633]|       activeTaskId = nextPending ? nextPending.id : null;
[F10:634]|     }
[F10:635]|   }
[F10:636]| 
[F10:637]|   saveTasks();
[F10:638]|   renderTasks();
[F10:639]| }
[F10:640]| 
[F10:641]| function parseMarkdownTasks(rawText) {
[F10:642]|   const lines = rawText.replace(/\r\n/g, "\n").split("\n");
[F10:643]| 
[F10:644]|   let documentTitle = null;
[F10:645]|   let groupTitle = null;
[F10:646]| 
[F10:647]|   const steps = [];
[F10:648]|   let currentStep = null;
[F10:649]| 
[F10:650]|   function flushCurrentStep() {
[F10:651]|     if (!currentStep) {
[F10:652]|       return;
[F10:653]|     }
[F10:654]| 
[F10:655]|     const details = currentStep.detailsLines
[F10:656]|       .join("\n")
[F10:657]|       .replace(/\s+$/g, "");
[F10:658]|     steps.push({
[F10:659]|       text: currentStep.text,
[F10:660]|       documentTitle: currentStep.documentTitle,
[F10:661]|       groupTitle: currentStep.groupTitle,
[F10:662]|       details,
[F10:663]|     });
[F10:664]|     currentStep = null;
[F10:665]|   }
[F10:666]| 
[F10:667]|   for (const line of lines) {
[F10:668]|     const trimmed = line.trimEnd();
[F10:669]|     if (!trimmed.trim()) {
[F10:670]|       continue;
[F10:671]|     }
[F10:672]| 
[F10:673]|     const headerMatch = trimmed.match(/^(#{1,3})\s+(.*)$/);
[F10:674]|     if (headerMatch) {
[F10:675]|       const level = headerMatch[1].length;
[F10:676]|       const title = (headerMatch[2] || "").trim();
[F10:677]|       if (!title) {
[F10:678]|         continue;
[F10:679]|       }
[F10:680]| 
[F10:681]|       if (level === 1) {
[F10:682]|         flushCurrentStep();
[F10:683]|         documentTitle = title;
[F10:684]|         continue;
[F10:685]|       }
[F10:686]| 
[F10:687]|       if (level === 2) {
[F10:688]|         flushCurrentStep();
[F10:689]|         groupTitle = title;
[F10:690]|         continue;
[F10:691]|       }
[F10:692]| 
[F10:693]|       if (level === 3) {
[F10:694]|         flushCurrentStep();
[F10:695]|         currentStep = {
[F10:696]|           text: title,
[F10:697]|           documentTitle,
[F10:698]|           groupTitle,
[F10:699]|           detailsLines: [],
[F10:700]|         };
[F10:701]|         continue;
[F10:702]|       }
[F10:703]|     }
[F10:704]| 
[F10:705]|     const isIndented = /^\s+/.test(line);
[F10:706]|     if (currentStep && isIndented) {
[F10:707]|       const normalized = line.startsWith("\t")
[F10:708]|         ? line.slice(1)
[F10:709]|         : line.replace(/^\s{1,2}/, "");
[F10:710]|       currentStep.detailsLines.push(normalized.trimEnd());
[F10:711]|     }
[F10:712]|   }
[F10:713]| 
[F10:714]|   flushCurrentStep();
[F10:715]|   return steps;
[F10:716]| }
[F10:717]| 
[F10:718]| function createTasksFromSteps(steps) {
[F10:719]|   return steps.map((step, index) => ({
[F10:720]|     id: Date.now() + index,
[F10:721]|     text: step.text,
[F10:722]|     status: "pending",
[F10:723]|     context_payload: {
[F10:724]|       document_title: step.documentTitle,
[F10:725]|       group_title: step.groupTitle,
[F10:726]|       details: step.details,
[F10:727]|     },
[F10:728]|   }));
[F10:729]| }
[F10:730]| 
[F10:731]| function insertTasksAfter(taskId, newTasks) {
[F10:732]|   const insertIndex = tasks.findIndex((task) => task.id === taskId);
[F10:733]|   if (insertIndex === -1) {
[F10:734]|     tasks = [...tasks, ...newTasks];
[F10:735]|     return;
[F10:736]|   }
[F10:737]|   tasks.splice(insertIndex + 1, 0, ...newTasks);
[F10:738]| }
[F10:739]| 
[F10:740]| function setDecomposeButtonLoading(button, isLoading) {
[F10:741]|   if (!button) {
[F10:742]|     return;
[F10:743]|   }
[F10:744]|   button.classList.toggle("loading", isLoading);
[F10:745]|   button.disabled = isLoading;
[F10:746]|   button.textContent = isLoading ? "Working..." : "Decompose";
[F10:747]| }
[F10:748]| 
[F10:749]| async function decomposeTask(taskId, button) {
[F10:750]|   const task = tasks.find((item) => item.id === taskId);
[F10:751]|   if (!task) {
[F10:752]|     return;
[F10:753]|   }
[F10:754]| 
[F10:755]|   if (button?.disabled) {
[F10:756]|     return;
[F10:757]|   }
[F10:758]| 
[F10:759]|   const provider = providers[currentProviderIdx] || {
[F10:760]|     name: "Default",
[F10:761]|     key: "",
[F10:762]|     url: DEFAULT_BASE_URL,
[F10:763]|     model: DEFAULT_MODEL,
[F10:764]|   };
[F10:765]| 
[F10:766]|   const apiKey = (provider.key || "").trim();
[F10:767]|   if (!apiKey) {
[F10:768]|     alert("Missing API Key. Open Settings to configure an API.");
[F10:769]|     return;
[F10:770]|   }
[F10:771]| 
[F10:772]|   setDecomposeButtonLoading(button, true);
[F10:773]| 
[F10:774]|   const baseUrl = (provider.url || DEFAULT_BASE_URL).trim() || DEFAULT_BASE_URL;
[F10:775]|   const normalizedBaseUrl = baseUrl.replace(/\/+$/, "");
[F10:776]|   const endpointUrl = `${normalizedBaseUrl}/chat/completions`;
[F10:777]|   const model = (provider.model || DEFAULT_MODEL).trim() || DEFAULT_MODEL;
[F10:778]| 
[F10:779]|   const { details } = getActiveTaskMeta(task);
[F10:780]|   const inputText = [task.text, details].filter(Boolean).join("\n\n");
[F10:781]| 
[F10:782]|   const promptTemplate = (await loadTodoListPrompt()) || DEFAULT_TODOLIST_PROMPT_TEMPLATE;
[F10:783]|   const systemPrompt = injectTodoListInput(promptTemplate, inputText);
[F10:784]| 
[F10:785]|   try {
[F10:786]|     const response = await fetch(endpointUrl, {
[F10:787]|       method: "POST",
[F10:788]|       headers: {
[F10:789]|         "Content-Type": "application/json",
[F10:790]|         Authorization: `Bearer ${apiKey}`,
[F10:791]|       },
[F10:792]|       body: JSON.stringify({
[F10:793]|         model,
[F10:794]|         messages: [{ role: "system", content: systemPrompt }],
[F10:795]|       }),
[F10:796]|     });
[F10:797]| 
[F10:798]|     if (!response.ok) {
[F10:799]|       const errorText = await response.text();
[F10:800]|       throw new Error(errorText || "API request failed.");
[F10:801]|     }
[F10:802]| 
[F10:803]|     const data = await response.json();
[F10:804]|     const reply = data.choices?.[0]?.message?.content || "";
[F10:805]|     const trimmedReply = reply.trim();
[F10:806]|     if (!trimmedReply) {
[F10:807]|       throw new Error("Empty response from assistant.");
[F10:808]|     }
[F10:809]|     if (trimmedReply === "NOT_A_TODOLIST") {
[F10:810]|       alert("No todo list detected in this task.");
[F10:811]|       return;
[F10:812]|     }
[F10:813]| 
[F10:814]|     const steps = parseMarkdownTasks(trimmedReply);
[F10:815]|     if (steps.length === 0) {
[F10:816]|       alert("No steps found in decomposition output.");
[F10:817]|       return;
[F10:818]|     }
[F10:819]| 
[F10:820]|     const newTasks = createTasksFromSteps(steps);
[F10:821]|     insertTasksAfter(taskId, newTasks);
[F10:822]|     saveTasks();
[F10:823]|     renderTasks();
[F10:824]|   } catch (error) {
[F10:825]|     alert(`Decompose failed: ${error.message}`);
[F10:826]|   } finally {
[F10:827]|     setDecomposeButtonLoading(button, false);
[F10:828]|   }
[F10:829]| }
[F10:830]| 
[F10:831]| async function convertAndIngestTasks() {
[F10:832]|   const rawText = taskInput.value;
[F10:833]|   if (!rawText || !rawText.trim()) {
[F10:834]|     return;
[F10:835]|   }
[F10:836]| 
[F10:837]|   const provider = providers[currentProviderIdx] || {
[F10:838]|     name: "Default",
[F10:839]|     key: "",
[F10:840]|     url: DEFAULT_BASE_URL,
[F10:841]|     model: DEFAULT_MODEL,
[F10:842]|   };
[F10:843]| 
[F10:844]|   const apiKey = (provider.key || "").trim();
[F10:845]|   if (!apiKey) {
[F10:846]|     alert("Missing API Key. Open Settings to configure an API.");
[F10:847]|     return;
[F10:848]|   }
[F10:849]| 
[F10:850]|   setAddTasksLoading(true);
[F10:851]| 
[F10:852]|   const baseUrl = (provider.url || DEFAULT_BASE_URL).trim() || DEFAULT_BASE_URL;
[F10:853]|   const normalizedBaseUrl = baseUrl.replace(/\/+$/, "");
[F10:854]|   const endpointUrl = `${normalizedBaseUrl}/chat/completions`;
[F10:855]|   const model = (provider.model || DEFAULT_MODEL).trim() || DEFAULT_MODEL;
[F10:856]| 
[F10:857]|   const promptTemplate = (await loadTodoListPrompt()) || DEFAULT_TODOLIST_PROMPT_TEMPLATE;
[F10:858]|   const systemPrompt = injectTodoListInput(promptTemplate, rawText);
[F10:859]| 
[F10:860]|   try {
[F10:861]|     const response = await fetch(endpointUrl, {
[F10:862]|       method: "POST",
[F10:863]|       headers: {
[F10:864]|         "Content-Type": "application/json",
[F10:865]|         Authorization: `Bearer ${apiKey}`,
[F10:866]|       },
[F10:867]|       body: JSON.stringify({
[F10:868]|         model,
[F10:869]|         messages: [{ role: "system", content: systemPrompt }],
[F10:870]|       }),
[F10:871]|     });
[F10:872]| 
[F10:873]|     if (!response.ok) {
[F10:874]|       const errorText = await response.text();
[F10:875]|       throw new Error(errorText || "API request failed.");
[F10:876]|     }
[F10:877]| 
[F10:878]|     const data = await response.json();
[F10:879]|     const rawResult = data.choices?.[0]?.message?.content || "";
[F10:880]|     
[F10:881]|     if (rawResult.trim() === "NOT_A_TODOLIST") {
[F10:882]|       alert("AI did not detect a valid task list in your input.");
[F10:883]|       return;
[F10:884]|     }
[F10:885]| 
[F10:886]|     const steps = parseMarkdownTasks(rawResult);
[F10:887]| 
[F10:888]|     if (steps.length === 0) {
[F10:889]|       alert("AI failed to generate valid Rail tasks. Please review the input material.");
[F10:890]|       return;
[F10:891]|     }
[F10:892]| 
[F10:893]|     const newTasks = createTasksFromSteps(steps);
[F10:894]|     // Replace current tasks with the full list from editor
[F10:895]|     tasks = newTasks; 
[F10:896]|     taskInput.value = "";
[F10:897]| 
[F10:898]|     if (newTasks.length > 0) {
[F10:899]|       // Keep active task if it still exists, else pick first
[F10:900]|       const stillExists = tasks.some(t => t.id === activeTaskId);
[F10:901]|       if (!stillExists) {
[F10:902]|         activeTaskId = newTasks[0].id;
[F10:903]|       }
[F10:904]|     } else {
[F10:905]|       activeTaskId = null;
[F10:906]|     }
[F10:907]| 
[F10:908]|     saveTasks();
[F10:909]|     renderTasks();
[F10:910]|     closeEditorPage();
[F10:911]|   } catch (error) {
[F10:912]|     alert(`Conversion failed: ${error.message}`);
[F10:913]|   } finally {
[F10:914]|     setAddTasksLoading(false);
[F10:915]|   }
[F10:916]| }
[F10:917]| 
[F10:918]| function ingestTasks() {
[F10:919]|   const rawText = taskInput.value;
[F10:920]|   if (!rawText || !rawText.trim()) {
[F10:921]|     return;
[F10:922]|   }
[F10:923]| 
[F10:924]|   // Spec (v1):
[F10:925]|   // - `### ` headings define steps (ingested as tasks).
[F10:926]|   // - Indented continuation lines under a step become `context_payload.details`.
[F10:927]|   // - `#` (doc title) and `##` (group) are captured as metadata for future use.
[F10:928]|   const steps = parseMarkdownTasks(rawText);
[F10:929]|   if (steps.length === 0) {
[F10:930]|     alert("No steps found. Use Markdown headings like `### Step name`.");
[F10:931]|     return;
[F10:932]|   }
[F10:933]| 
[F10:934]|   const newTasks = createTasksFromSteps(steps);
[F10:935]| 
[F10:936]|   // Replace current tasks with the full list from editor
[F10:937]|   tasks = newTasks; 
[F10:938]|   taskInput.value = "";
[F10:939]| 
[F10:940]|   if (tasks.length > 0) {
[F10:941]|     const exists = tasks.some(t => t.id === activeTaskId);
[F10:942]|     if (!exists) {
[F10:943]|       activeTaskId = tasks[0].id;
[F10:944]|     }
[F10:945]|   } else {
[F10:946]|     activeTaskId = null;
[F10:947]|   }
[F10:948]| 
[F10:949]|   saveTasks();
[F10:950]|   renderTasks();
[F10:951]|   closeEditorPage();
[F10:952]| }
[F10:953]| 
[F10:954]| function clearAllTasks() {
[F10:955]|   if (tasks.length === 0) {
[F10:956]|     return;
[F10:957]|   }
[F10:958]| 
[F10:959]|   const confirmed = confirm("Clear all tasks? This cannot be undone.");
[F10:960]|   if (!confirmed) {
[F10:961]|     return;
[F10:962]|   }
[F10:963]| 
[F10:964]|   tasks = [];
[F10:965]|   activeTaskId = null;
[F10:966]|   saveTasks();
[F10:967]|   renderTasks();
[F10:968]| 
[F10:969]|   if (taskInput) {
[F10:970]|     taskInput.value = "";
[F10:971]|   }
[F10:972]| 
[F10:973]|   chatHistory = [];
[F10:974]|   chatMessages.innerHTML = "";
[F10:975]|   persistChatHistory();
[F10:976]|   appendMessage("system", "Tasks cleared.");
[F10:977]| 
[F10:978]|   if (taskInput) {
[F10:979]|     taskInput.focus();
[F10:980]|   }
[F10:981]| }
[F10:982]| 
[F10:983]| function showOverview() {
[F10:984]|   if (!activeTaskId) {
[F10:985]|     return;
[F10:986]|   }
[F10:987]|   activeTaskId = null;
[F10:988]|   saveTasks();
[F10:989]|   renderTasks();
[F10:990]| }
[F10:991]| 
[F10:992]| function normalizeProviders(raw) {
[F10:993]|   const parsed = Array.isArray(raw) ? raw : [];
[F10:994]|   const normalized = parsed
[F10:995]|     .map((p, idx) => ({
[F10:996]|       name: (p?.name || `Config ${idx + 1}`).trim(),
[F10:997]|       key: (p?.key || "").trim(),
[F10:998]|       url: (p?.url || DEFAULT_BASE_URL).trim(),
[F10:999]|       model: (p?.model || DEFAULT_MODEL).trim(),
[F10:1000]|     }))
[F10:1001]|     .filter((p) => p.name);
[F10:1002]| 
[F10:1003]|   if (normalized.length === 0) {
[F10:1004]|     normalized.push({
[F10:1005]|       name: "Default",
[F10:1006]|       key: "",
[F10:1007]|       url: DEFAULT_BASE_URL,
[F10:1008]|       model: DEFAULT_MODEL,
[F10:1009]|     });
[F10:1010]|   }
[F10:1011]|   return normalized;
[F10:1012]| }
[F10:1013]| 
[F10:1014]| function persistProviders() {
[F10:1015]|   localStorage.setItem(PROVIDERS_KEY, JSON.stringify(providers));
[F10:1016]|   localStorage.setItem(ACTIVE_PROVIDER_INDEX, String(currentProviderIdx));
[F10:1017]| }
[F10:1018]| 
[F10:1019]| function loadSettings() {
[F10:1020]|   const raw = localStorage.getItem(PROVIDERS_KEY);
[F10:1021]|   let parsed;
[F10:1022]|   try {
[F10:1023]|     parsed = raw ? JSON.parse(raw) : null;
[F10:1024]|   } catch (error) {
[F10:1025]|     parsed = null;
[F10:1026]|   }
[F10:1027]|   providers = normalizeProviders(parsed);
[F10:1028]| 
[F10:1029]|   currentProviderIdx = Number(localStorage.getItem(ACTIVE_PROVIDER_INDEX)) || 0;
[F10:1030]|   if (currentProviderIdx < 0 || currentProviderIdx >= providers.length) {
[F10:1031]|     currentProviderIdx = 0;
[F10:1032]|   }
[F10:1033]| 
[F10:1034]|   const storedLayout = localStorage.getItem(LAYOUT_MODE_KEY);
[F10:1035]|   layoutMode = storedLayout === "inline" || storedLayout === "split" || storedLayout === "nano" ? storedLayout : "split";
[F10:1036]|   if (layoutModeSelect) {
[F10:1037]|     layoutModeSelect.value = layoutMode;
[F10:1038]|   }
[F10:1039]| }
[F10:1040]| 
[F10:1041]| function renderProvidersList() {
[F10:1042]|   if (!providersList) {
[F10:1043]|     return;
[F10:1044]|   }
[F10:1045]| 
[F10:1046]|   providersList.innerHTML = "";
[F10:1047]|   providers.forEach((provider, index) => {
[F10:1048]|     const row = document.createElement("div");
[F10:1049]|     row.className = "provider-row";
[F10:1050]|     if (index === currentProviderIdx) {
[F10:1051]|       row.classList.add("active");
[F10:1052]|     }
[F10:1053]| 
[F10:1054]|     const main = document.createElement("div");
[F10:1055]|     main.className = "provider-row-main";
[F10:1056]| 
[F10:1057]|     const name = document.createElement("div");
[F10:1058]|     name.className = "provider-row-name";
[F10:1059]|     name.textContent = provider.name || `Config ${index + 1}`;
[F10:1060]| 
[F10:1061]|     const meta = document.createElement("div");
[F10:1062]|     meta.className = "provider-row-meta";
[F10:1063]|     const url = (provider.url || DEFAULT_BASE_URL).replace(/\/+$/, "");
[F10:1064]|     meta.textContent = `${url} · ${provider.model || DEFAULT_MODEL}`;
[F10:1065]| 
[F10:1066]|     main.appendChild(name);
[F10:1067]|     main.appendChild(meta);
[F10:1068]| 
[F10:1069]|     const badge = document.createElement("div");
[F10:1070]|     badge.className = "provider-row-badge";
[F10:1071]|     badge.textContent = index === currentProviderIdx ? "Selected" : "Use";
[F10:1072]| 
[F10:1073]|     row.appendChild(main);
[F10:1074]|     row.appendChild(badge);
[F10:1075]|     row.addEventListener("click", () => {
[F10:1076]|       currentProviderIdx = index;
[F10:1077]|       localStorage.setItem(ACTIVE_PROVIDER_INDEX, String(currentProviderIdx));
[F10:1078]|       renderProvidersList();
[F10:1079]|       fillProviderForm();
[F10:1080]|     });
[F10:1081]|     providersList.appendChild(row);
[F10:1082]|   });
[F10:1083]| }
[F10:1084]| 
[F10:1085]| function fillProviderForm() {
[F10:1086]|   const provider = providers[currentProviderIdx];
[F10:1087]|   if (!provider) {
[F10:1088]|     return;
[F10:1089]|   }
[F10:1090]|   if (providerNameInput) {
[F10:1091]|     providerNameInput.value = provider.name || "";
[F10:1092]|   }
[F10:1093]|   if (providerKeyInput) {
[F10:1094]|     providerKeyInput.value = provider.key || "";
[F10:1095]|   }
[F10:1096]|   if (providerUrlInput) {
[F10:1097]|     providerUrlInput.value = provider.url || DEFAULT_BASE_URL;
[F10:1098]|   }
[F10:1099]|   if (providerModelInput) {
[F10:1100]|     providerModelInput.value = provider.model || DEFAULT_MODEL;
[F10:1101]|   }
[F10:1102]| }
[F10:1103]| 
[F10:1104]| function saveSelectedProviderFromForm() {
[F10:1105]|   const provider = providers[currentProviderIdx];
[F10:1106]|   if (!provider) {
[F10:1107]|     return;
[F10:1108]|   }
[F10:1109]| 
[F10:1110]|   provider.name = (providerNameInput?.value || provider.name || "").trim() || provider.name;
[F10:1111]|   provider.key = (providerKeyInput?.value || "").trim();
[F10:1112]|   provider.url = (providerUrlInput?.value || DEFAULT_BASE_URL).trim() || DEFAULT_BASE_URL;
[F10:1113]|   provider.model = (providerModelInput?.value || DEFAULT_MODEL).trim() || DEFAULT_MODEL;
[F10:1114]|   persistProviders();
[F10:1115]|   renderProvidersList();
[F10:1116]| }
[F10:1117]| 
[F10:1118]| function createNewProvider() {
[F10:1119]|   const nextName = `Config ${providers.length + 1}`;
[F10:1120]|   providers.push({
[F10:1121]|     name: nextName,
[F10:1122]|     key: "",
[F10:1123]|     url: DEFAULT_BASE_URL,
[F10:1124]|     model: DEFAULT_MODEL,
[F10:1125]|   });
[F10:1126]|   currentProviderIdx = providers.length - 1;
[F10:1127]|   persistProviders();
[F10:1128]|   renderProvidersList();
[F10:1129]|   fillProviderForm();
[F10:1130]| }
[F10:1131]| 
[F10:1132]| function deleteSelectedProvider() {
[F10:1133]|   if (providers.length <= 1) {
[F10:1134]|     alert("At least one API config is required.");
[F10:1135]|     return;
[F10:1136]|   }
[F10:1137]|   const confirmed = confirm("Delete selected API config?");
[F10:1138]|   if (!confirmed) {
[F10:1139]|     return;
[F10:1140]|   }
[F10:1141]|   providers.splice(currentProviderIdx, 1);
[F10:1142]|   currentProviderIdx = Math.max(0, currentProviderIdx - 1);
[F10:1143]|   persistProviders();
[F10:1144]|   renderProvidersList();
[F10:1145]|   fillProviderForm();
[F10:1146]| }
[F10:1147]| 
[F10:1148]| function appendMessage(role, content) {
[F10:1149]|   const bubble = document.createElement("div");
[F10:1150]|   bubble.className = `chat-bubble ${role} md`;
[F10:1151]|   bubble.innerHTML = renderMarkdownToSafeHtml(content);
[F10:1152]|   enhanceCodeBlocks(bubble);
[F10:1153]|   chatMessages.appendChild(bubble);
[F10:1154]|   chatMessages.scrollTop = chatMessages.scrollHeight;
[F10:1155]|   persistChatHistory();
[F10:1156]| }
[F10:1157]| 
[F10:1158]| async function loadSystemPrompt() {
[F10:1159]|   try {
[F10:1160]|     const promptUrl =
[F10:1161]|       typeof chrome !== "undefined" && chrome.runtime?.getURL
[F10:1162]|         ? chrome.runtime.getURL(PROMPT_PATH)
[F10:1163]|         : PROMPT_PATH;
[F10:1164]|     const response = await fetch(promptUrl);
[F10:1165]|     if (!response.ok) {
[F10:1166]|       return;
[F10:1167]|     }
[F10:1168]|     const text = await response.text();
[F10:1169]|     if (text && text.trim()) {
[F10:1170]|       systemPromptTemplate = text.trim();
[F10:1171]|     }
[F10:1172]|   } catch (error) {
[F10:1173]|     systemPromptTemplate = DEFAULT_SYSTEM_PROMPT_TEMPLATE;
[F10:1174]|   }
[F10:1175]| }
[F10:1176]| 
[F10:1177]| async function loadTodoListPrompt() {
[F10:1178]|   if (todolistPromptTemplate) {
[F10:1179]|     return todolistPromptTemplate;
[F10:1180]|   }
[F10:1181]|   try {
[F10:1182]|     const promptUrl =
[F10:1183]|       typeof chrome !== "undefined" && chrome.runtime?.getURL
[F10:1184]|         ? chrome.runtime.getURL(TODOLIST_PROMPT_PATH)
[F10:1185]|         : TODOLIST_PROMPT_PATH;
[F10:1186]|     const response = await fetch(promptUrl);
[F10:1187]|     if (!response.ok) {
[F10:1188]|       return null;
[F10:1189]|     }
[F10:1190]|     const text = await response.text();
[F10:1191]|     todolistPromptTemplate = text?.trim() || null;
[F10:1192]|     return todolistPromptTemplate;
[F10:1193]|   } catch (error) {
[F10:1194]|     return null;
[F10:1195]|   }
[F10:1196]| }
[F10:1197]| 
[F10:1198]| function injectTodoListInput(template, inputText) {
[F10:1199]|   const markerStart = "<<<INPUT";
[F10:1200]|   const markerEnd = "INPUT";
[F10:1201]|   if (template && template.includes(markerStart) && template.includes(markerEnd)) {
[F10:1202]|     return template.replace(new RegExp(`${markerStart}[\\s\\S]*?${markerEnd}`), `${markerStart}\n${inputText}\n${markerEnd}`);
[F10:1203]|   }
[F10:1204]|   return `${template || ""}\n\n${markerStart}\n${inputText}\n${markerEnd}\n`;
[F10:1205]| }
[F10:1206]| 
[F10:1207]| function buildSystemPrompt(activeTaskText) {
[F10:1208]|   const template = systemPromptTemplate || DEFAULT_SYSTEM_PROMPT_TEMPLATE;
[F10:1209]|   const totalTasks = tasks.length;
[F10:1210]|   const doneTasks = tasks.filter((task) => task.status === "done").length;
[F10:1211]|   const activeTaskDetails = getActiveTaskMeta(getActiveTask()).details || "(no details)";
[F10:1212]|   const pendingTasks = tasks
[F10:1213]|     .filter((task) => task.status === "pending")
[F10:1214]|     .map((task) => `- ${task.text}`)
[F10:1215]|     .join("\n");
[F10:1216]|   const pendingText = pendingTasks || "All tasks completed!";
[F10:1217]| 
[F10:1218]|   return template
[F10:1219]|     .replaceAll("{TOTAL_TASKS}", String(totalTasks))
[F10:1220]|     .replaceAll("{DONE_TASKS}", String(doneTasks))
[F10:1221]|     .replaceAll("{PENDING_TASKS}", pendingText)
[F10:1222]|     .replaceAll("{ACTIVE_TASK}", activeTaskText)
[F10:1223]|     .replaceAll("{TASK_DETAILS}", activeTaskDetails);
[F10:1224]| }
[F10:1225]| 
[F10:1226]| function persistChatHistory() {
[F10:1227]|   localStorage.setItem(TEMP_CHAT_KEY, JSON.stringify(chatHistory));
[F10:1228]| }
[F10:1229]| 
[F10:1230]| function clearChatContext() {
[F10:1231]|   chatHistory = [];
[F10:1232]|   chatMessages.innerHTML = "";
[F10:1233]|   localStorage.removeItem(TEMP_CHAT_KEY);
[F10:1234]|   appendMessage("system", "Context switched. Memory cleared.");
[F10:1235]| }
[F10:1236]| 
[F10:1237]| function clearChatHistory() {
[F10:1238]|   chatHistory = [];
[F10:1239]|   chatMessages.innerHTML = "";
[F10:1240]|   localStorage.removeItem(TEMP_CHAT_KEY);
[F10:1241]|   appendMessage("system", "Chat cleared.");
[F10:1242]| }
[F10:1243]| 
[F10:1244]| function restoreChatHistory() {
[F10:1245]|   if (chatHistory.length === 0) {
[F10:1246]|     return;
[F10:1247]|   }
[F10:1248]| 
[F10:1249]|   chatMessages.innerHTML = "";
[F10:1250]|   chatHistory.forEach((message) => {
[F10:1251]|     if (!message?.role || !message?.content) {
[F10:1252]|       return;
[F10:1253]|     }
[F10:1254]|     appendMessage(message.role, message.content);
[F10:1255]|   });
[F10:1256]| }
[F10:1257]| 
[F10:1258]| async function sendChat() {
[F10:1259]|   const question = chatInput.value.trim();
[F10:1260]|   if (!question) {
[F10:1261]|     return;
[F10:1262]|   }
[F10:1263]| 
[F10:1264]|   const provider = providers[currentProviderIdx] || {
[F10:1265]|     name: "Default",
[F10:1266]|     key: "",
[F10:1267]|     url: DEFAULT_BASE_URL,
[F10:1268]|     model: DEFAULT_MODEL,
[F10:1269]|   };
[F10:1270]| 
[F10:1271]|   const apiKey = (provider.key || "").trim();
[F10:1272]|   if (!apiKey) {
[F10:1273]|     alert("Missing API Key. Open Settings to configure an API.");
[F10:1274]|     return;
[F10:1275]|   }
[F10:1276]| 
[F10:1277]|   const baseUrl = (provider.url || DEFAULT_BASE_URL).trim() || DEFAULT_BASE_URL;
[F10:1278]|   const normalizedBaseUrl = baseUrl.replace(/\/+$/, "");
[F10:1279]|   const endpointUrl = `${normalizedBaseUrl}/chat/completions`;
[F10:1280]|   const model = (provider.model || DEFAULT_MODEL).trim() || DEFAULT_MODEL;
[F10:1281]|   const activeTask = tasks.find((task) => task.id === activeTaskId);
[F10:1282]|   const activeTaskText = activeTask ? activeTask.text : "None";
[F10:1283]| 
[F10:1284]|   chatInput.value = "";
[F10:1285]|   appendMessage("user", question);
[F10:1286]|   chatStatus.textContent = "Thinking...";
[F10:1287]| 
[F10:1288]|   // Inject active task context into the system prompt.
[F10:1289]|   const systemPrompt = buildSystemPrompt(activeTaskText);
[F10:1290]| 
[F10:1291]|   chatHistory.push({ role: "user", content: question });
[F10:1292]| 
[F10:1293]|   try {
[F10:1294]|     const response = await fetch(endpointUrl, {
[F10:1295]|       method: "POST",
[F10:1296]|       headers: {
[F10:1297]|         "Content-Type": "application/json",
[F10:1298]|         Authorization: `Bearer ${apiKey}`,
[F10:1299]|       },
[F10:1300]|       body: JSON.stringify({
[F10:1301]|         model,
[F10:1302]|         stream: true,
[F10:1303]|         messages: [{ role: "system", content: systemPrompt }, ...chatHistory],
[F10:1304]|       }),
[F10:1305]|     });
[F10:1306]| 
[F10:1307]|     if (!response.ok) {
[F10:1308]|       const errorText = await response.text();
[F10:1309]|       throw new Error(errorText || "API request failed.");
[F10:1310]|     }
[F10:1311]|     const contentType = response.headers.get("content-type") || "";
[F10:1312]|     const isEventStream = contentType.includes("text/event-stream");
[F10:1313]| 
[F10:1314]|     if (!response.body || !isEventStream) {
[F10:1315]|       const data = await response.json();
[F10:1316]|       const reply =
[F10:1317]|         data.choices?.[0]?.message?.content || "No response from assistant.";
[F10:1318]|       chatHistory.push({ role: "assistant", content: reply });
[F10:1319]|       appendMessage("assistant", reply);
[F10:1320]|       return;
[F10:1321]|     }
[F10:1322]| 
[F10:1323]|     const assistantBubble = document.createElement("div");
[F10:1324]|     assistantBubble.className = "chat-bubble assistant md";
[F10:1325]|     assistantBubble.innerHTML = renderMarkdownToSafeHtml("");
[F10:1326]|     chatMessages.appendChild(assistantBubble);
[F10:1327]| 
[F10:1328]|     let assistantText = "";
[F10:1329]|     let pendingText = "";
[F10:1330]|     let streamDone = false;
[F10:1331]|     let typingTimer = null;
[F10:1332]|     const typingInterval = 18;
[F10:1333]|     const charsPerTick = 3;
[F10:1334]| 
[F10:1335]|     const updateBubble = (text) => {
[F10:1336]|       assistantBubble.innerHTML = renderMarkdownToSafeHtml(text);
[F10:1337]|       enhanceCodeBlocks(assistantBubble);
[F10:1338]|       chatMessages.scrollTop = chatMessages.scrollHeight;
[F10:1339]|     };
[F10:1340]| 
[F10:1341]|     const startTyping = () => {
[F10:1342]|       if (typingTimer) {
[F10:1343]|         return;
[F10:1344]|       }
[F10:1345]|       typingTimer = setInterval(() => {
[F10:1346]|         if (!pendingText.length) {
[F10:1347]|           if (streamDone) {
[F10:1348]|             clearInterval(typingTimer);
[F10:1349]|             typingTimer = null;
[F10:1350]|           }
[F10:1351]|           return;
[F10:1352]|         }
[F10:1353]|         const chunk = pendingText.slice(0, charsPerTick);
[F10:1354]|         pendingText = pendingText.slice(charsPerTick);
[F10:1355]|         assistantText += chunk;
[F10:1356]|         updateBubble(assistantText);
[F10:1357]|       }, typingInterval);
[F10:1358]|     };
[F10:1359]| 
[F10:1360]|     const waitForTyping = () =>
[F10:1361]|       new Promise((resolve) => {
[F10:1362]|         const check = () => {
[F10:1363]|           if (!pendingText.length) {
[F10:1364]|             resolve();
[F10:1365]|             return;
[F10:1366]|           }
[F10:1367]|           setTimeout(check, 30);
[F10:1368]|         };
[F10:1369]|         check();
[F10:1370]|       });
[F10:1371]| 
[F10:1372]|     const reader = response.body.getReader();
[F10:1373]|     const decoder = new TextDecoder("utf-8");
[F10:1374]|     let buffer = "";
[F10:1375]| 
[F10:1376]|     while (true) {
[F10:1377]|       const { value, done } = await reader.read();
[F10:1378]|       if (done) {
[F10:1379]|         break;
[F10:1380]|       }
[F10:1381]|       buffer += decoder.decode(value, { stream: true });
[F10:1382]|       const lines = buffer.split("\n");
[F10:1383]|       buffer = lines.pop() || "";
[F10:1384]| 
[F10:1385]|       for (const line of lines) {
[F10:1386]|         const trimmed = line.trim();
[F10:1387]|         if (!trimmed || !trimmed.startsWith("data:")) {
[F10:1388]|           continue;
[F10:1389]|         }
[F10:1390]|         const data = trimmed.slice(5).trim();
[F10:1391]|         if (data === "[DONE]") {
[F10:1392]|           streamDone = true;
[F10:1393]|           break;
[F10:1394]|         }
[F10:1395]|         try {
[F10:1396]|           const payload = JSON.parse(data);
[F10:1397]|           const delta = payload.choices?.[0]?.delta?.content ?? payload.choices?.[0]?.message?.content ?? "";
[F10:1398]|           if (delta) {
[F10:1399]|             pendingText += delta;
[F10:1400]|             startTyping();
[F10:1401]|           }
[F10:1402]|         } catch (error) {
[F10:1403]|           // Ignore malformed stream chunks.
[F10:1404]|         }
[F10:1405]|       }
[F10:1406]| 
[F10:1407]|       if (streamDone) {
[F10:1408]|         break;
[F10:1409]|       }
[F10:1410]|     }
[F10:1411]| 
[F10:1412]|     streamDone = true;
[F10:1413]|     startTyping();
[F10:1414]|     await waitForTyping();
[F10:1415]| 
[F10:1416]|     if (typingTimer) {
[F10:1417]|       clearInterval(typingTimer);
[F10:1418]|       typingTimer = null;
[F10:1419]|     }
[F10:1420]| 
[F10:1421]|     if (pendingText.length) {
[F10:1422]|       assistantText += pendingText;
[F10:1423]|       pendingText = "";
[F10:1424]|       updateBubble(assistantText);
[F10:1425]|     }
[F10:1426]| 
[F10:1427]|     if (!assistantText) {
[F10:1428]|       assistantText = "No response from assistant.";
[F10:1429]|       updateBubble(assistantText);
[F10:1430]|     }
[F10:1431]| 
[F10:1432]|     const reply = assistantText;
[F10:1433]|     chatHistory.push({ role: "assistant", content: reply });
[F10:1434]|     persistChatHistory();
[F10:1435]|   } catch (error) {
[F10:1436]|     appendMessage("assistant", `Error: ${error.message}`);
[F10:1437]|   } finally {
[F10:1438]|     chatStatus.textContent = "";
[F10:1439]|   }
[F10:1440]| }
[F10:1441]| 
[F10:1442]| function tasksToMarkdown(taskListData) {
[F10:1443]|   if (!taskListData || taskListData.length === 0) {
[F10:1444]|     return "";
[F10:1445]|   }
[F10:1446]|   
[F10:1447]|   let md = "";
[F10:1448]|   let lastDocTitle = null;
[F10:1449]|   let lastGroupTitle = null;
[F10:1450]| 
[F10:1451]|   taskListData.forEach((task) => {
[F10:1452]|     const meta = task.context_payload || {};
[F10:1453]|     
[F10:1454]|     // Add document title if it changed
[F10:1455]|     if (meta.document_title && meta.document_title !== lastDocTitle) {
[F10:1456]|       md += `# ${meta.document_title}\n\n`;
[F10:1457]|       lastDocTitle = meta.document_title;
[F10:1458]|       lastGroupTitle = null; // Reset group title when doc changes
[F10:1459]|     }
[F10:1460]|     
[F10:1461]|     // Add group title if it changed
[F10:1462]|     if (meta.group_title && meta.group_title !== lastGroupTitle) {
[F10:1463]|       md += `## ${meta.group_title}\n\n`;
[F10:1464]|       lastGroupTitle = meta.group_title;
[F10:1465]|     }
[F10:1466]|     
[F10:1467]|     md += `### ${task.text}\n`;
[F10:1468]|     if (meta.details) {
[F10:1469]|       // Indent details by 2 spaces
[F10:1470]|       const details = meta.details
[F10:1471]|         .split("\n")
[F10:1472]|         .map((line) => (line.trim() ? `  ${line}` : ""))
[F10:1473]|         .join("\n");
[F10:1474]|       md += `${details}\n`;
[F10:1475]|     }
[F10:1476]|     md += "\n";
[F10:1477]|   });
[F10:1478]|   
[F10:1479]|   return md.trim();
[F10:1480]| }
[F10:1481]| 
[F10:1482]| addTasksButton.addEventListener("click", async () => {
[F10:1483]|   if (aiConvertToggle?.checked) {
[F10:1484]|     await convertAndIngestTasks();
[F10:1485]|     return;
[F10:1486]|   }
[F10:1487]|   ingestTasks();
[F10:1488]| });
[F10:1489]| if (overviewTasksButton) {
[F10:1490]|   overviewTasksButton.addEventListener("click", showOverview);
[F10:1491]| }
[F10:1492]| clearTasksButton.addEventListener("click", clearAllTasks);
[F10:1493]| sendChatButton.addEventListener("click", sendChat);
[F10:1494]| clearChatButton.addEventListener("click", clearChatHistory);
[F10:1495]| 
[F10:1496]| if (openSettingsButton) {
[F10:1497]|   openSettingsButton.addEventListener("click", openSettingsPage);
[F10:1498]| }
[F10:1499]| 
[F10:1500]| if (settingsBackButton) {
[F10:1501]|   settingsBackButton.addEventListener("click", openMainPage);
[F10:1502]| }
[F10:1503]| 
[F10:1504]| if (addTaskToggle) {
[F10:1505]|   addTaskToggle.addEventListener("click", openEditorPage);
[F10:1506]| }
[F10:1507]| 
[F10:1508]| if (editorBackButton) {
[F10:1509]|   editorBackButton.addEventListener("click", closeEditorPage);
[F10:1510]| }
[F10:1511]| 
[F10:1512]| if (providerNewButton) {
[F10:1513]|   providerNewButton.addEventListener("click", createNewProvider);
[F10:1514]| }
[F10:1515]| 
[F10:1516]| if (providerSaveButton) {
[F10:1517]|   providerSaveButton.addEventListener("click", saveSelectedProviderFromForm);
[F10:1518]| }
[F10:1519]| 
[F10:1520]| if (providerDeleteButton) {
[F10:1521]|   providerDeleteButton.addEventListener("click", deleteSelectedProvider);
[F10:1522]| }
[F10:1523]| 
[F10:1524]| if (layoutModeSelect) {
[F10:1525]|   layoutModeSelect.addEventListener("change", (event) => {
[F10:1526]|     const value = event.target.value;
[F10:1527]|     layoutMode = value === "inline" || value === "split" || value === "nano" ? value : "split";
[F10:1528]|     persistLayoutMode();
[F10:1529]|     ensureActiveTaskSelection();
[F10:1530]|     renderTasks();
[F10:1531]|   });
[F10:1532]| }
[F10:1533]| 
[F10:1534]| if (chatDrawerToggle) {
[F10:1535]|   chatDrawerToggle.addEventListener("click", () => {
[F10:1536]|     setChatCollapsed(!chatCollapsed);
[F10:1537]|   });
[F10:1538]| }
[F10:1539]| 
[F10:1540]| chatInput.addEventListener("keydown", (event) => {
[F10:1541]|   if (event.key === "Enter") {
[F10:1542]|     sendChat();
[F10:1543]|   }
[F10:1544]| });
[F10:1545]| 
[F10:1546]| document.addEventListener("keydown", (event) => {
[F10:1547]|   if (!event.altKey) {
[F10:1548]|     return;
[F10:1549]|   }
[F10:1550]|   const key = event.key.toLowerCase();
[F10:1551]|   if (event.key === "enter") {
[F10:1552]|     event.preventDefault();
[F10:1553]|     const nextCollapsed = !chatCollapsed;
[F10:1554]|     setChatCollapsed(nextCollapsed);
[F10:1555]|     if (!nextCollapsed && chatInput) {
[F10:1556]|       chatInput.focus();
[F10:1557]|       chatInput.select();
[F10:1558]|     }
[F10:1559]|     return;
[F10:1560]|   }
[F10:1561]|   if (key === "d") {
[F10:1562]|     event.preventDefault();
[F10:1563]|     markActiveTaskDoneAndNext();
[F10:1564]|     return;
[F10:1565]|   }
[F10:1566]|   if (key === "n") {
[F10:1567]|     event.preventDefault();
[F10:1568]|     toggleInlineNanoLayout();
[F10:1569]|   }
[F10:1570]| });
[F10:1571]| 
[F10:1572]| document.addEventListener("DOMContentLoaded", () => {
[F10:1573]|   loadSettings();
[F10:1574]|   loadTasks();
[F10:1575]|   ensureActiveTaskSelection();
[F10:1576]|   applyLayoutMode();
[F10:1577]|   renderProvidersList();
[F10:1578]|   fillProviderForm();
[F10:1579]|   renderTasks();
[F10:1580]|   restoreChatHistory();
[F10:1581]|   loadSystemPrompt();
[F10:1582]|   setChatCollapsed(true);
[F10:1583]|   if ("serviceWorker" in navigator && window.location.protocol !== "chrome-extension:") {
[F10:1584]|     navigator.serviceWorker.register("./service-worker.js").catch(() => {});
[F10:1585]|   }
[F10:1586]| });

================================================================================
文件路径: service-worker.js(F11) (约合大小: 1 KB)
================================================================================
[F11:1]| const CACHE_NAME = "rail-pwa-v2";
[F11:2]| const ASSETS = [
[F11:3]|   "./",
[F11:4]|   "./sidepanel.html",
[F11:5]|   "./styles.css",
[F11:6]|   "./script.js",
[F11:7]|   "./marked.min.js",
[F11:8]|   "./system_prompt.txt",
[F11:9]|   "./todolist_get.txt",
[F11:10]|   "./manifest.webmanifest",
[F11:11]|   "./icon-192.png",
[F11:12]|   "./icon-512.png",
[F11:13]| ];
[F11:14]| 
[F11:15]| self.addEventListener("install", (event) => {
[F11:16]|   event.waitUntil(
[F11:17]|     caches.open(CACHE_NAME).then(async (cache) => {
[F11:18]|       // Cache assets individually so a missing optional asset (e.g. marked.min.js)
[F11:19]|       // doesn't break the whole service worker install.
[F11:20]|       await Promise.all(
[F11:21]|         ASSETS.map((asset) =>
[F11:22]|           cache.add(asset).catch(() => {
[F11:23]|             // ignore
[F11:24]|           })
[F11:25]|         )
[F11:26]|       );
[F11:27]|       await self.skipWaiting();
[F11:28]|     })
[F11:29]|   );
[F11:30]| });
[F11:31]| 
[F11:32]| self.addEventListener("activate", (event) => {
[F11:33]|   event.waitUntil(
[F11:34]|     caches
[F11:35]|       .keys()
[F11:36]|       .then((keys) =>
[F11:37]|         Promise.all(
[F11:38]|           keys
[F11:39]|             .filter((key) => key !== CACHE_NAME)
[F11:40]|             .map((key) => caches.delete(key))
[F11:41]|         )
[F11:42]|       )
[F11:43]|       .then(() => self.clients.claim())
[F11:44]|   );
[F11:45]| });
[F11:46]| 
[F11:47]| self.addEventListener("fetch", (event) => {
[F11:48]|   if (event.request.method !== "GET") {
[F11:49]|     return;
[F11:50]|   }
[F11:51]| 
[F11:52]|   event.respondWith(
[F11:53]|     caches.match(event.request).then((cached) => {
[F11:54]|       if (cached) {
[F11:55]|         return cached;
[F11:56]|       }
[F11:57]|       return fetch(event.request).then((response) => {
[F11:58]|         if (!response || response.status !== 200 || response.type !== "basic") {
[F11:59]|           return response;
[F11:60]|         }
[F11:61]|         const responseClone = response.clone();
[F11:62]|         caches.open(CACHE_NAME).then((cache) => cache.put(event.request, responseClone));
[F11:63]|         return response;
[F11:64]|       });
[F11:65]|     })
[F11:66]|   );
[F11:67]| });

================================================================================
文件路径: sidepanel.html(F12) (约合大小: 6 KB)
================================================================================
[F12:1]| <!doctype html>
[F12:2]| <html lang="en">
[F12:3]|   <head>
[F12:4]|     <meta charset="UTF-8" />
[F12:5]|     <meta name="viewport" content="width=device-width, initial-scale=1.0" />
[F12:6]|     <title>Rail</title>
[F12:7]|     <link rel="manifest" href="manifest.webmanifest" />
[F12:8]|     <meta name="theme-color" content="#1e1e1e" />
[F12:9]|     <link rel="stylesheet" href="styles.css" />
[F12:10]|   </head>
[F12:11]|   <body>
[F12:12]|     <div class="app">
[F12:13]|       <div id="main-page" class="page">
[F12:14]|         <section class="tasks">
[F12:15]|           <header class="panel-header">
[F12:16]|             <div class="header-top">
[F12:17]|               <h1>Rail</h1>
[F12:18]|               <div class="header-actions">
[F12:19]|                 <button id="add-task-toggle" class="icon-button" title="Add or Edit Tasks">
[F12:20]|                   <span class="icon-plus">+</span>
[F12:21]|                 </button>
[F12:22]|               </div>
[F12:23]|             </div>
[F12:24]|             <p>Context Anchor · Execution GPS</p>
[F12:25]|             <p id="task-doc-title" class="doc-title"></p>
[F12:26]|           </header>
[F12:27]| 
[F12:28]|           <div class="tasks-body">
[F12:29]|             <div id="task-list" class="task-list" aria-live="polite"></div>
[F12:30]|             <aside id="task-details" class="task-details" aria-label="Active task details">
[F12:31]|               <div class="task-details-title" id="task-details-step"></div>
[F12:32]|               <div class="task-details-meta" id="task-details-meta"></div>
[F12:33]|               <div class="task-details-body md" id="task-details-body"></div>
[F12:34]|             </aside>
[F12:35]|           </div>
[F12:36]|           <div class="progress-bar-container">
[F12:37]|             <div id="progress-bar-fill" class="progress-bar-fill"></div>
[F12:38]|             <div id="task-progress" class="task-progress task-status" aria-live="polite"></div>
[F12:39]|           </div>
[F12:40]|         </section>
[F12:41]| 
[F12:42]|         <section class="chat">
[F12:43]|           <div class="chat-toolbar">
[F12:44]|             <button
[F12:45]|               id="chat-drawer-toggle"
[F12:46]|               class="chat-drawer-toggle settings-toggle"
[F12:47]|               aria-label="Toggle chat drawer"
[F12:48]|               title="Toggle chat"
[F12:49]|             >
[F12:50]|               ▼
[F12:51]|             </button>
[F12:52]|             <button id="clear-chat" class="clear-chat" aria-label="Clear chat">Clear</button>
[F12:53]|             <button id="open-settings" class="settings-toggle" aria-label="Open settings">
[F12:54]|               <span class="settings-icon" aria-hidden="true">&#9881;</span>
[F12:55]|             </button>
[F12:56]|           </div>
[F12:57]|           <div id="chat-messages" class="chat-messages"></div>
[F12:58]|           <div id="chat-status" class="chat-status"></div>
[F12:59]|           <div class="chat-input">
[F12:60]|             <input id="chat-input" type="text" placeholder="Ask about the active task..." />
[F12:61]|             <button id="send-chat">Send</button>
[F12:62]|           </div>
[F12:63]|         </section>
[F12:64]|       </div>
[F12:65]| 
[F12:66]|       <div id="editor-page" class="page hidden" aria-label="Task Editor">
[F12:67]|         <header class="settings-header">
[F12:68]|           <button id="editor-back" class="settings-back" aria-label="Back">Back</button>
[F12:69]|           <h2>Task Editor</h2>
[F12:70]|         </header>
[F12:71]| 
[F12:72]|         <section class="settings-section">
[F12:73]|           <div class="ingest-standalone">
[F12:74]|             <textarea id="task-input" placeholder="Paste Markdown steps (###), e.g.\n### Do thing\n  details..."></textarea>
[F12:75]|             
[F12:76]|             <div class="editor-actions">
[F12:77]|               <button id="add-tasks" class="primary-button">Update Task List</button>
[F12:78]|               
[F12:79]|               <div class="editor-options">
[F12:80]|                 <label class="ingest-toggle-ui" title="Use AI to convert raw text into Rail tasks">
[F12:81]|                   <input id="ai-convert" type="checkbox" />
[F12:82]|                   <span>AI Convert</span>
[F12:83]|                 </label>
[F12:84]|               </div>
[F12:85]|             </div>
[F12:86]| 
[F12:87]|             <div class="secondary-actions">
[F12:88]|               <button id="overview-tasks" class="text-button">Get Tasks from AI Clipboard</button>
[F12:89]|               <button id="clear-tasks" class="danger-button">Clear All Tasks</button>
[F12:90]|             </div>
[F12:91]|           </div>
[F12:92]|           
[F12:93]|           <div class="editor-help">
[F12:94]|             <p>Format: Markdown headers (<code>###</code>) define steps. Indented text below the header becomes the step details.</p>
[F12:95]|           </div>
[F12:96]|         </section>
[F12:97]|       </div>
[F12:98]| 
[F12:99]|       <div id="settings-page" class="page hidden" aria-label="Settings">
[F12:100]|         <header class="settings-header">
[F12:101]|           <button id="settings-back" class="settings-back" aria-label="Back">Back</button>
[F12:102]|           <h2>Settings</h2>
[F12:103]|         </header>
[F12:104]| 
[F12:105]|         <section class="settings-section">
[F12:106]|           <h3>AI API Configs</h3>
[F12:107]|           <div class="providers-toolbar">
[F12:108]|             <button id="provider-new" class="provider-new">New</button>
[F12:109]|           </div>
[F12:110]|           <div id="providers-list" class="providers-list" aria-live="polite"></div>
[F12:111]|         </section>
[F12:112]| 
[F12:113]|         <section class="settings-section">
[F12:114]|           <h3>Selected API</h3>
[F12:115]|           <div class="provider-form">
[F12:116]|             <label>
[F12:117]|               Name
[F12:118]|               <input id="provider-name" type="text" placeholder="My API" />
[F12:119]|             </label>
[F12:120]|             <label>
[F12:121]|               API Key
[F12:122]|               <input id="provider-key" type="password" placeholder="sk-..." />
[F12:123]|             </label>
[F12:124]|             <label>
[F12:125]|               Base URL
[F12:126]|               <input id="provider-url" type="text" placeholder="https://api.openai.com" />
[F12:127]|             </label>
[F12:128]|             <label>
[F12:129]|               Model
[F12:130]|               <input id="provider-model" type="text" placeholder="gpt-4o-mini" />
[F12:131]|             </label>
[F12:132]|             <div class="provider-form-actions">
[F12:133]|               <button id="provider-save" class="provider-save">Save</button>
[F12:134]|               <button id="provider-delete" class="provider-delete" aria-label="Delete selected API">Delete</button>
[F12:135]|             </div>
[F12:136]|           </div>
[F12:137]|         </section>
[F12:138]| 
[F12:139]|         <section class="settings-section">
[F12:140]|           <h3>Layout</h3>
[F12:141]|           <label>
[F12:142]|             Task Layout
[F12:143]|             <select id="layout-mode" aria-label="Task layout">
[F12:144]|               <option value="split">Split (list + details)</option>
[F12:145]|               <option value="inline">Inline (active shows details)</option>
[F12:146]|               <option value="nano">Nano (prev/current/next)</option>
[F12:147]|             </select>
[F12:148]|           </label>
[F12:149]|         </section>
[F12:150]|       </div>
[F12:151]|     </div>
[F12:152]|     <script src="marked.min.js"></script>
[F12:153]|     <script src="script.js"></script>
[F12:154]|   </body>
[F12:155]| </html>

================================================================================
文件路径: styles.css(F13) (约合大小: 14 KB)
================================================================================
[F13:1]| :root {
[F13:2]|   color-scheme: dark;
[F13:3]|   --bg: #1e1e1e;
[F13:4]|   --panel: #252526;
[F13:5]|   --border: #333333;
[F13:6]|   --text: #e5e7eb;
[F13:7]|   --muted: #9ca3af;
[F13:8]|   --accent: #3b82f6;
[F13:9]|   --accent-soft: rgba(59, 130, 246, 0.15);
[F13:10]|   --done: #10b981;
[F13:11]|   --fg: #ffffff;
[F13:12]|   --bg-item: #111827;
[F13:13]|   --bg-item-hover: #1f2937;
[F13:14]|   --font-mono: "Courier New", Courier, monospace;
[F13:15]| }
[F13:16]| 
[F13:17]| * {
[F13:18]|   box-sizing: border-box;
[F13:19]| }
[F13:20]| 
[F13:21]| body {
[F13:22]|   margin: 0;
[F13:23]|   font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
[F13:24]|   background: var(--bg);
[F13:25]|   color: var(--text);
[F13:26]|   height: 100vh;
[F13:27]| }
[F13:28]| 
[F13:29]| .app {
[F13:30]|   display: flex;
[F13:31]|   flex-direction: column;
[F13:32]|   height: 100vh;
[F13:33]| }
[F13:34]| 
[F13:35]| .page {
[F13:36]|   flex: 1;
[F13:37]|   display: flex;
[F13:38]|   flex-direction: column;
[F13:39]|   height: 100%;
[F13:40]| }
[F13:41]| 
[F13:42]| .hidden {
[F13:43]|   display: none;
[F13:44]| }
[F13:45]| 
[F13:46]| .tasks {
[F13:47]|   flex: 6;
[F13:48]|   display: flex;
[F13:49]|   flex-direction: column;
[F13:50]|   gap: 12px;
[F13:51]|   padding: 16px;
[F13:52]|   border-bottom: 1px solid var(--border);
[F13:53]|   overflow: hidden;
[F13:54]| }
[F13:55]| 
[F13:56]| .panel-header h1 {
[F13:57]|   margin: 0;
[F13:58]|   font-size: 20px;
[F13:59]| }
[F13:60]| 
[F13:61]| .panel-header p {
[F13:62]|   margin: 4px 0 0;
[F13:63]|   color: var(--muted);
[F13:64]|   font-size: 12px;
[F13:65]| }
[F13:66]| 
[F13:67]| .doc-title {
[F13:68]|   min-height: 14px;
[F13:69]| }
[F13:70]| 
[F13:71]| .ingest {
[F13:72]|   display: flex;
[F13:73]|   gap: 8px;
[F13:74]| }
[F13:75]| 
[F13:76]| .ingest-toggle {
[F13:77]|   display: inline-flex;
[F13:78]|   align-items: center;
[F13:79]|   gap: 6px;
[F13:80]|   font-size: 12px;
[F13:81]|   color: var(--muted);
[F13:82]|   padding: 0 6px;
[F13:83]|   border: 1px solid var(--border);
[F13:84]|   border-radius: 8px;
[F13:85]|   background: transparent;
[F13:86]| }
[F13:87]| 
[F13:88]| .ingest-toggle input {
[F13:89]|   margin: 0;
[F13:90]| }
[F13:91]| 
[F13:92]| .ingest button {
[F13:93]|   padding: 6px 10px;
[F13:94]|   font-size: 12px;
[F13:95]| }
[F13:96]| 
[F13:97]| #overview-tasks {
[F13:98]|   display: none;
[F13:99]| }
[F13:100]| 
[F13:101]| .layout-nano #overview-tasks {
[F13:102]|   display: inline-flex;
[F13:103]| }
[F13:104]| 
[F13:105]| #task-input {
[F13:106]|   flex: 1;
[F13:107]|   min-height: 68px;
[F13:108]|   background: var(--panel);
[F13:109]|   border: 1px solid var(--border);
[F13:110]|   color: var(--text);
[F13:111]|   padding: 8px;
[F13:112]|   border-radius: 8px;
[F13:113]|   resize: vertical;
[F13:114]| }
[F13:115]| 
[F13:116]| button {
[F13:117]|   background: var(--accent);
[F13:118]|   border: none;
[F13:119]|   color: white;
[F13:120]|   padding: 8px 12px;
[F13:121]|   border-radius: 8px;
[F13:122]|   cursor: pointer;
[F13:123]|   font-weight: 600;
[F13:124]| }
[F13:125]| 
[F13:126]| button:hover {
[F13:127]|   background: #2563eb;
[F13:128]| }
[F13:129]| 
[F13:130]| .clear-tasks {
[F13:131]|   background: transparent;
[F13:132]|   border: 1px solid var(--border);
[F13:133]|   color: var(--muted);
[F13:134]| }
[F13:135]| 
[F13:136]| .clear-tasks:hover {
[F13:137]|   background: var(--panel);
[F13:138]|   color: var(--text);
[F13:139]| }
[F13:140]| 
[F13:141]| .task-list {
[F13:142]|   flex: 1;
[F13:143]|   overflow-y: auto;
[F13:144]|   display: flex;
[F13:145]|   flex-direction: column;
[F13:146]|   gap: 8px;
[F13:147]|   padding-right: 4px;
[F13:148]| }
[F13:149]| 
[F13:150]| .tasks-body {
[F13:151]|   flex: 1;
[F13:152]|   display: flex;
[F13:153]|   gap: 12px;
[F13:154]|   overflow: hidden;
[F13:155]| }
[F13:156]| 
[F13:157]| .task-details {
[F13:158]|   flex: 1;
[F13:159]|   border: 1px solid var(--border);
[F13:160]|   background: var(--panel);
[F13:161]|   border-radius: 10px;
[F13:162]|   padding: 10px 12px;
[F13:163]|   overflow-y: auto;
[F13:164]|   display: flex;
[F13:165]|   flex-direction: column;
[F13:166]|   gap: 8px;
[F13:167]| }
[F13:168]| 
[F13:169]| .task-details-title {
[F13:170]|   font-weight: 700;
[F13:171]| }
[F13:172]| 
[F13:173]| .task-details-meta {
[F13:174]|   font-size: 12px;
[F13:175]|   color: var(--muted);
[F13:176]| }
[F13:177]| 
[F13:178]| .task-details-body {
[F13:179]|   font-size: 12px;
[F13:180]|   line-height: 1.4;
[F13:181]| }
[F13:182]| 
[F13:183]| .task-item-row {
[F13:184]|   display: flex;
[F13:185]|   justify-content: space-between;
[F13:186]|   align-items: center;
[F13:187]|   gap: 10px;
[F13:188]| }
[F13:189]| 
[F13:190]| .task-item.with-details {
[F13:191]|   flex-direction: column;
[F13:192]|   align-items: stretch;
[F13:193]|   gap: 8px;
[F13:194]| }
[F13:195]| 
[F13:196]| .task-inline-meta {
[F13:197]|   font-size: 12px;
[F13:198]|   color: var(--muted);
[F13:199]| }
[F13:200]| 
[F13:201]| .task-inline-details {
[F13:202]|   font-size: 12px;
[F13:203]|   line-height: 1.4;
[F13:204]| }
[F13:205]| 
[F13:206]| .layout-inline .task-details {
[F13:207]|   display: none;
[F13:208]| }
[F13:209]| 
[F13:210]| .layout-nano .task-details {
[F13:211]|   display: none;
[F13:212]| }
[F13:213]| 
[F13:214]| .task-item {
[F13:215]|   border: 1px solid var(--border);
[F13:216]|   background: var(--panel);
[F13:217]|   padding: 10px 12px;
[F13:218]|   border-radius: 10px;
[F13:219]|   display: flex;
[F13:220]|   justify-content: space-between;
[F13:221]|   align-items: center;
[F13:222]|   cursor: pointer;
[F13:223]|   transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease,
[F13:224]|     transform 0.25s ease, opacity 0.25s ease;
[F13:225]| }
[F13:226]| 
[F13:227]| .decompose-btn {
[F13:228]|   background: transparent;
[F13:229]|   border: 1px solid var(--border);
[F13:230]|   color: var(--muted);
[F13:231]|   padding: 4px 8px;
[F13:232]|   border-radius: 8px;
[F13:233]|   font-size: 11px;
[F13:234]|   cursor: pointer;
[F13:235]|   font-weight: 600;
[F13:236]| }
[F13:237]| 
[F13:238]| .decompose-btn:hover {
[F13:239]|   background: var(--panel);
[F13:240]|   color: var(--text);
[F13:241]| }
[F13:242]| 
[F13:243]| .decompose-btn.loading {
[F13:244]|   cursor: wait;
[F13:245]|   opacity: 0.7;
[F13:246]| }
[F13:247]| 
[F13:248]| .task-item.active {
[F13:249]|   border-color: var(--accent);
[F13:250]|   background: var(--accent-soft);
[F13:251]|   border-left: 4px solid var(--accent);
[F13:252]|   box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.15);
[F13:253]|   animation: task-breathe 2.4s ease-in-out infinite;
[F13:254]| }
[F13:255]| 
[F13:256]| @keyframes task-breathe {
[F13:257]|   0% {
[F13:258]|     box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.10);
[F13:259]|     transform: translateY(0);
[F13:260]|   }
[F13:261]|   50% {
[F13:262]|     box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.22);
[F13:263]|     transform: translateY(-1px);
[F13:264]|   }
[F13:265]|   100% {
[F13:266]|     box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.10);
[F13:267]|     transform: translateY(0);
[F13:268]|   }
[F13:269]| }
[F13:270]| 
[F13:271]| @media (prefers-reduced-motion: reduce) {
[F13:272]|   .task-item {
[F13:273]|     transition: none;
[F13:274]|   }
[F13:275]| 
[F13:276]|   .task-item.active {
[F13:277]|     animation: none;
[F13:278]|     transform: none;
[F13:279]|   }
[F13:280]| }
[F13:281]| 
[F13:282]| .nano-view .task-item.nano-secondary {
[F13:283]|   opacity: 0.4;
[F13:284]|   padding-top: 8px;
[F13:285]|   padding-bottom: 8px;
[F13:286]| }
[F13:287]| 
[F13:288]| .task-item.done {
[F13:289]|   opacity: 0.6;
[F13:290]|   text-decoration: line-through;
[F13:291]| }
[F13:292]| 
[F13:293]| .task-status {
[F13:294]|   font-size: 12px;
[F13:295]|   color: var(--muted);
[F13:296]| }
[F13:297]| 
[F13:298]| .task-progress {
[F13:299]|   position: relative;
[F13:300]|   z-index: 2;
[F13:301]|   text-align: center;
[F13:302]|   font-size: 10px;
[F13:303]|   line-height: 14px;
[F13:304]|   color: var(--fg);
[F13:305]|   font-weight: 600;
[F13:306]|   text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
[F13:307]| }
[F13:308]| 
[F13:309]| .progress-bar-container {
[F13:310]|   margin-top: 12px;
[F13:311]|   position: relative;
[F13:312]|   height: 14px;
[F13:313]|   background: var(--bg-item);
[F13:314]|   border-radius: 2px;
[F13:315]|   overflow: hidden;
[F13:316]|   box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
[F13:317]| }
[F13:318]| 
[F13:319]| .progress-bar-fill {
[F13:320]|   position: absolute;
[F13:321]|   top: 0;
[F13:322]|   left: 0;
[F13:323]|   height: 100%;
[F13:324]|   width: 0%;
[F13:325]|   background: linear-gradient(90deg, #3b82f6, #60a5fa);
[F13:326]|   transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
[F13:327]|   z-index: 1;
[F13:328]| }
[F13:329]| 
[F13:330]| .chat {
[F13:331]|   flex: 4;
[F13:332]|   display: flex;
[F13:333]|   flex-direction: column;
[F13:334]|   gap: 10px;
[F13:335]|   padding: 16px;
[F13:336]|   overflow: hidden;
[F13:337]| }
[F13:338]| 
[F13:339]| body.chat-collapsed .chat {
[F13:340]|   flex: 0 0 auto;
[F13:341]|   max-height: 44px;
[F13:342]|   padding-top: 10px;
[F13:343]|   padding-bottom: 10px;
[F13:344]| }
[F13:345]| 
[F13:346]| body.chat-collapsed .chat-messages,
[F13:347]| body.chat-collapsed .chat-status {
[F13:348]|   display: none;
[F13:349]| }
[F13:350]| 
[F13:351]| .chat-input {
[F13:352]|   transition: opacity 0.2s ease, transform 0.2s ease, max-height 0.2s ease;
[F13:353]|   max-height: 64px;
[F13:354]| }
[F13:355]| 
[F13:356]| body.chat-collapsed .chat-input {
[F13:357]|   opacity: 0;
[F13:358]|   transform: translateY(-4px);
[F13:359]|   max-height: 0;
[F13:360]|   pointer-events: none;
[F13:361]|   overflow: hidden;
[F13:362]| }
[F13:363]| 
[F13:364]| .chat-toolbar {
[F13:365]|   display: flex;
[F13:366]|   justify-content: flex-end;
[F13:367]|   gap: 8px;
[F13:368]| }
[F13:369]| 
[F13:370]| .clear-chat {
[F13:371]|   background: transparent;
[F13:372]|   border: 1px solid var(--border);
[F13:373]|   color: var(--muted);
[F13:374]|   padding: 6px 10px;
[F13:375]|   border-radius: 8px;
[F13:376]|   cursor: pointer;
[F13:377]|   font-weight: 600;
[F13:378]| }
[F13:379]| 
[F13:380]| .clear-chat:hover {
[F13:381]|   background: var(--panel);
[F13:382]|   color: var(--text);
[F13:383]| }
[F13:384]| 
[F13:385]| .settings-toggle {
[F13:386]|   background: transparent;
[F13:387]|   border: 1px solid var(--border);
[F13:388]|   color: var(--muted);
[F13:389]|   padding: 6px 8px;
[F13:390]|   border-radius: 8px;
[F13:391]|   cursor: pointer;
[F13:392]| }
[F13:393]| 
[F13:394]| .settings-icon {
[F13:395]|   font-size: 16px;
[F13:396]|   line-height: 1;
[F13:397]| }
[F13:398]| 
[F13:399]| .settings-toggle:hover {
[F13:400]|   background: var(--panel);
[F13:401]|   color: var(--text);
[F13:402]| }
[F13:403]| 
[F13:404]| .settings-header {
[F13:405]|   display: flex;
[F13:406]|   align-items: center;
[F13:407]|   gap: 10px;
[F13:408]|   padding: 16px;
[F13:409]|   border-bottom: 1px solid var(--border);
[F13:410]| }
[F13:411]| 
[F13:412]| .settings-header h2 {
[F13:413]|   margin: 0;
[F13:414]|   font-size: 16px;
[F13:415]| }
[F13:416]| 
[F13:417]| .settings-back {
[F13:418]|   background: transparent;
[F13:419]|   border: 1px solid var(--border);
[F13:420]|   color: var(--muted);
[F13:421]|   padding: 6px 10px;
[F13:422]|   border-radius: 8px;
[F13:423]|   cursor: pointer;
[F13:424]|   font-weight: 600;
[F13:425]| }
[F13:426]| 
[F13:427]| .settings-back:hover {
[F13:428]|   background: var(--panel);
[F13:429]|   color: var(--text);
[F13:430]| }
[F13:431]| 
[F13:432]| .settings-section {
[F13:433]|   padding: 16px;
[F13:434]|   display: flex;
[F13:435]|   flex-direction: column;
[F13:436]|   gap: 10px;
[F13:437]| }
[F13:438]| 
[F13:439]| .settings-section h3 {
[F13:440]|   margin: 0;
[F13:441]|   font-size: 13px;
[F13:442]|   color: var(--muted);
[F13:443]|   text-transform: uppercase;
[F13:444]|   letter-spacing: 0.04em;
[F13:445]| }
[F13:446]| 
[F13:447]| .providers-toolbar {
[F13:448]|   display: flex;
[F13:449]|   justify-content: flex-end;
[F13:450]| }
[F13:451]| 
[F13:452]| .providers-list {
[F13:453]|   display: flex;
[F13:454]|   flex-direction: column;
[F13:455]|   gap: 8px;
[F13:456]| }
[F13:457]| 
[F13:458]| .provider-row {
[F13:459]|   border: 1px solid var(--border);
[F13:460]|   background: var(--panel);
[F13:461]|   border-radius: 10px;
[F13:462]|   padding: 10px 12px;
[F13:463]|   cursor: pointer;
[F13:464]|   display: flex;
[F13:465]|   justify-content: space-between;
[F13:466]|   align-items: center;
[F13:467]|   gap: 12px;
[F13:468]| }
[F13:469]| 
[F13:470]| .provider-row.active {
[F13:471]|   border-color: var(--accent);
[F13:472]|   background: var(--accent-soft);
[F13:473]| }
[F13:474]| 
[F13:475]| .provider-row-main {
[F13:476]|   display: flex;
[F13:477]|   flex-direction: column;
[F13:478]|   gap: 2px;
[F13:479]|   min-width: 0;
[F13:480]| }
[F13:481]| 
[F13:482]| .provider-row-name {
[F13:483]|   font-weight: 700;
[F13:484]|   white-space: nowrap;
[F13:485]|   overflow: hidden;
[F13:486]|   text-overflow: ellipsis;
[F13:487]| }
[F13:488]| 
[F13:489]| .provider-row-meta {
[F13:490]|   font-size: 12px;
[F13:491]|   color: var(--muted);
[F13:492]|   white-space: nowrap;
[F13:493]|   overflow: hidden;
[F13:494]|   text-overflow: ellipsis;
[F13:495]| }
[F13:496]| 
[F13:497]| .provider-row-badge {
[F13:498]|   font-size: 12px;
[F13:499]|   color: var(--muted);
[F13:500]|   border: 1px solid var(--border);
[F13:501]|   padding: 4px 8px;
[F13:502]|   border-radius: 999px;
[F13:503]| }
[F13:504]| 
[F13:505]| .provider-form {
[F13:506]|   display: flex;
[F13:507]|   flex-direction: column;
[F13:508]|   gap: 10px;
[F13:509]| }
[F13:510]| 
[F13:511]| .provider-form label,
[F13:512]| .settings-section label {
[F13:513]|   font-size: 12px;
[F13:514]|   display: flex;
[F13:515]|   flex-direction: column;
[F13:516]|   gap: 4px;
[F13:517]| }
[F13:518]| 
[F13:519]| .provider-form input,
[F13:520]| .provider-form select,
[F13:521]| .settings-section select {
[F13:522]|   background: var(--panel);
[F13:523]|   border: 1px solid var(--border);
[F13:524]|   color: var(--text);
[F13:525]|   padding: 8px;
[F13:526]|   border-radius: 8px;
[F13:527]| }
[F13:528]| 
[F13:529]| .provider-form-actions {
[F13:530]|   display: flex;
[F13:531]|   gap: 8px;
[F13:532]|   justify-content: flex-end;
[F13:533]| }
[F13:534]| 
[F13:535]| .provider-delete {
[F13:536]|   background: transparent;
[F13:537]|   border: 1px solid var(--border);
[F13:538]|   color: var(--muted);
[F13:539]| }
[F13:540]| 
[F13:541]| .provider-delete:hover {
[F13:542]|   background: var(--panel);
[F13:543]|   color: var(--text);
[F13:544]| }
[F13:545]| 
[F13:546]| .settings {
[F13:547]|   display: none;
[F13:548]|   flex-direction: column;
[F13:549]|   gap: 12px;
[F13:550]|   background: var(--bg);
[F13:551]|   padding: 12px;
[F13:552]|   border: 1px solid var(--border);
[F13:553]|   border-radius: 8px;
[F13:554]| }
[F13:555]| 
[F13:556]| .settings.visible {
[F13:557]|   display: flex;
[F13:558]| }
[F13:559]| 
[F13:560]| .provider-manager {
[F13:561]|   display: flex;
[F13:562]|   gap: 6px;
[F13:563]| }
[F13:564]| 
[F13:565]| .provider-manager select {
[F13:566]|   flex: 1;
[F13:567]|   background: var(--panel);
[F13:568]|   border: 1px solid var(--border);
[F13:569]|   color: var(--text);
[F13:570]|   padding: 6px 8px;
[F13:571]|   border-radius: 8px;
[F13:572]| }
[F13:573]| 
[F13:574]| .provider-action {
[F13:575]|   background: transparent;
[F13:576]|   border: 1px solid var(--border);
[F13:577]|   color: var(--muted);
[F13:578]|   padding: 6px 10px;
[F13:579]|   border-radius: 8px;
[F13:580]|   cursor: pointer;
[F13:581]|   font-weight: 600;
[F13:582]| }
[F13:583]| 
[F13:584]| .provider-action:hover {
[F13:585]|   background: var(--panel);
[F13:586]|   color: var(--text);
[F13:587]| }
[F13:588]| 
[F13:589]| .settings label {
[F13:590]|   font-size: 12px;
[F13:591]|   display: flex;
[F13:592]|   flex-direction: column;
[F13:593]|   gap: 4px;
[F13:594]| }
[F13:595]| 
[F13:596]| .settings input {
[F13:597]|   background: var(--panel);
[F13:598]|   border: 1px solid var(--border);
[F13:599]|   color: var(--text);
[F13:600]|   padding: 6px 8px;
[F13:601]|   border-radius: 8px;
[F13:602]| }
[F13:603]| 
[F13:604]| .chat-messages {
[F13:605]|   flex: 1;
[F13:606]|   overflow-y: auto;
[F13:607]|   background: var(--panel);
[F13:608]|   border: 1px solid var(--border);
[F13:609]|   padding: 10px;
[F13:610]|   border-radius: 10px;
[F13:611]|   display: flex;
[F13:612]|   flex-direction: column;
[F13:613]|   gap: 8px;
[F13:614]| }
[F13:615]| 
[F13:616]| .chat-bubble {
[F13:617]|   padding: 8px 10px;
[F13:618]|   border-radius: 10px;
[F13:619]|   max-width: 90%;
[F13:620]|   line-height: 1.4;
[F13:621]|   font-family: inherit;
[F13:622]| }
[F13:623]| 
[F13:624]| .md {
[F13:625]|   white-space: normal;
[F13:626]|   overflow-wrap: anywhere;
[F13:627]| }
[F13:628]| 
[F13:629]| .md p {
[F13:630]|   margin: 0 0 8px;
[F13:631]| }
[F13:632]| 
[F13:633]| .md p:last-child {
[F13:634]|   margin-bottom: 0;
[F13:635]| }
[F13:636]| 
[F13:637]| .md ul,
[F13:638]| .md ol {
[F13:639]|   margin: 8px 0;
[F13:640]|   padding-left: 20px;
[F13:641]| }
[F13:642]| 
[F13:643]| .md li {
[F13:644]|   margin: 2px 0;
[F13:645]| }
[F13:646]| 
[F13:647]| .md pre {
[F13:648]|   margin: 8px 0;
[F13:649]|   padding: 10px 12px;
[F13:650]|   background: #111827;
[F13:651]|   border: 1px solid var(--border);
[F13:652]|   border-radius: 10px;
[F13:653]|   overflow-x: auto;
[F13:654]|   position: relative;
[F13:655]| }
[F13:656]| 
[F13:657]| .copy-code {
[F13:658]|   position: absolute;
[F13:659]|   top: 6px;
[F13:660]|   right: 6px;
[F13:661]|   background: rgba(15, 23, 42, 0.8);
[F13:662]|   color: var(--text);
[F13:663]|   border: 1px solid rgba(148, 163, 184, 0.3);
[F13:664]|   border-radius: 8px;
[F13:665]|   padding: 2px 6px;
[F13:666]|   font-size: 10px;
[F13:667]|   cursor: pointer;
[F13:668]|   opacity: 0.65;
[F13:669]|   transition: opacity 0.2s ease, transform 0.2s ease;
[F13:670]| }
[F13:671]| 
[F13:672]| .copy-code:hover {
[F13:673]|   opacity: 1;
[F13:674]|   transform: translateY(-1px);
[F13:675]| }
[F13:676]| 
[F13:677]| .md code {
[F13:678]|   font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
[F13:679]|     monospace;
[F13:680]|   font-size: 11px;
[F13:681]| }
[F13:682]| 
[F13:683]| .md :not(pre) > code {
[F13:684]|   padding: 1px 6px;
[F13:685]|   border-radius: 8px;
[F13:686]|   border: 1px solid var(--border);
[F13:687]|   background: var(--bg);
[F13:688]| }
[F13:689]| 
[F13:690]| .md a {
[F13:691]|   color: var(--accent);
[F13:692]|   text-decoration: none;
[F13:693]| }
[F13:694]| 
[F13:695]| .md a:hover {
[F13:696]|   text-decoration: underline;
[F13:697]| }
[F13:698]| 
[F13:699]| .md h1,
[F13:700]| .md h2,
[F13:701]| .md h3,
[F13:702]| .md h4,
[F13:703]| .md h5,
[F13:704]| .md h6 {
[F13:705]|   margin: 10px 0 6px;
[F13:706]|   font-size: 12px;
[F13:707]| }
[F13:708]| 
[F13:709]| .chat-bubble.user {
[F13:710]|   align-self: flex-end;
[F13:711]|   background: var(--accent);
[F13:712]|   color: white;
[F13:713]| }
[F13:714]| 
[F13:715]| .chat-bubble.assistant {
[F13:716]|   align-self: flex-start;
[F13:717]|   background: #111827;
[F13:718]|   color: var(--text);
[F13:719]| }
[F13:720]| 
[F13:721]| .chat-bubble.system {
[F13:722]|   align-self: center;
[F13:723]|   background: transparent;
[F13:724]|   color: var(--muted);
[F13:725]|   font-size: 12px;
[F13:726]| }
[F13:727]| 
[F13:728]| .chat-status {
[F13:729]|   min-height: 18px;
[F13:730]|   font-size: 12px;
[F13:731]|   color: var(--muted);
[F13:732]| }
[F13:733]| 
[F13:734]| .chat-input {
[F13:735]|   display: flex;
[F13:736]|   gap: 8px;
[F13:737]| }
[F13:738]| 
[F13:739]| #chat-input {
[F13:740]|   flex: 1;
[F13:741]|   background: var(--panel);
[F13:742]|   border: 1px solid var(--border);
[F13:743]|   color: var(--text);
[F13:744]|   padding: 8px 10px;
[F13:745]|   border-radius: 10px;
[F13:746]| }
[F13:747]| 
[F13:748]| .header-top {
[F13:749]|   display: flex;
[F13:750]|   justify-content: space-between;
[F13:751]|   align-items: center;
[F13:752]| }
[F13:753]| 
[F13:754]| .icon-button {
[F13:755]|   background: none;
[F13:756]|   border: none;
[F13:757]|   color: var(--muted);
[F13:758]|   cursor: pointer;
[F13:759]|   padding: 4px 8px;
[F13:760]|   border-radius: 4px;
[F13:761]|   display: flex;
[F13:762]|   align-items: center;
[F13:763]|   transition: background 0.2s, color 0.2s;
[F13:764]| }
[F13:765]| 
[F13:766]| .icon-button:hover {
[F13:767]|   background: var(--bg-item-hover);
[F13:768]|   color: var(--fg);
[F13:769]| }
[F13:770]| 
[F13:771]| .icon-plus {
[F13:772]|   font-size: 20px;
[F13:773]|   font-weight: 300;
[F13:774]| }
[F13:775]| 
[F13:776]| /* Editor Page Styles */
[F13:777]| #editor-page .settings-section {
[F13:778]|   flex: 1;
[F13:779]|   display: flex;
[F13:780]|   flex-direction: column;
[F13:781]|   overflow: hidden;
[F13:782]| }
[F13:783]| 
[F13:784]| .ingest-standalone {
[F13:785]|   flex: 1;
[F13:786]|   display: flex;
[F13:787]|   flex-direction: column;
[F13:788]|   gap: 16px;
[F13:789]|   overflow: hidden;
[F13:790]| }
[F13:791]| 
[F13:792]| .ingest-standalone textarea {
[F13:793]|   width: 100%;
[F13:794]|   flex: 1;
[F13:795]|   min-height: 400px;
[F13:796]|   background: var(--bg-item);
[F13:797]|   border: 1px solid var(--border);
[F13:798]|   color: var(--fg);
[F13:799]|   padding: 12px;
[F13:800]|   border-radius: 6px;
[F13:801]|   font-family: var(--font-mono);
[F13:802]|   font-size: 14px;
[F13:803]|   resize: none;
[F13:804]|   line-height: 1.6;
[F13:805]| }
[F13:806]| 
[F13:807]| .editor-actions {
[F13:808]|   display: flex;
[F13:809]|   justify-content: space-between;
[F13:810]|   align-items: center;
[F13:811]|   gap: 12px;
[F13:812]|   flex-shrink: 0;
[F13:813]| }
[F13:814]| 
[F13:815]| .primary-button {
[F13:816]|   background: #2563eb;
[F13:817]|   color: white;
[F13:818]|   border: none;
[F13:819]|   padding: 8px 16px;
[F13:820]|   border-radius: 4px;
[F13:821]|   font-weight: 500;
[F13:822]|   cursor: pointer;
[F13:823]| }
[F13:824]| 
[F13:825]| .primary-button:hover {
[F13:826]|   background: #3b82f6;
[F13:827]| }
[F13:828]| 
[F13:829]| .ingest-toggle-ui {
[F13:830]|   display: flex;
[F13:831]|   align-items: center;
[F13:832]|   gap: 6px;
[F13:833]|   font-size: 13px;
[F13:834]|   color: var(--muted);
[F13:835]|   cursor: pointer;
[F13:836]| }
[F13:837]| 
[F13:838]| .secondary-actions {
[F13:839]|   display: flex;
[F13:840]|   gap: 8px;
[F13:841]|   margin-top: 8px;
[F13:842]|   flex-shrink: 0;
[F13:843]| }
[F13:844]| 
[F13:845]| .text-button, .danger-button {
[F13:846]|   background: none;
[F13:847]|   border: 1px solid var(--border);
[F13:848]|   color: var(--muted);
[F13:849]|   padding: 6px 12px;
[F13:850]|   border-radius: 4px;
[F13:851]|   font-size: 12px;
[F13:852]|   cursor: pointer;
[F13:853]| }
[F13:854]| 
[F13:855]| .text-button:hover {
[F13:856]|   background: var(--bg-item-hover);
[F13:857]|   color: var(--fg);
[F13:858]| }
[F13:859]| 
[F13:860]| .danger-button:hover {
[F13:861]|   background: #991b1b;
[F13:862]|   color: white;
[F13:863]|   border-color: #ef4444;
[F13:864]| }
[F13:865]| 
[F13:866]| .editor-help {
[F13:867]|   margin-top: 24px;
[F13:868]|   padding: 12px;
[F13:869]|   background: rgba(59, 130, 246, 0.05);
[F13:870]|   border-radius: 6px;
[F13:871]|   font-size: 12px;
[F13:872]|   color: var(--muted);
[F13:873]|   line-height: 1.5;
[F13:874]| }
[F13:875]| 
[F13:876]| .editor-help code {
[F13:877]|   color: #60a5fa;
[F13:878]| }

--------------------------------------------------------------------------------
文件路径: system_prompt.txt(F14) (约合大小: 0 KB)
--------------------------------------------------------------------------------
[F14:1]| You are Rail, a developer's Execution GPS.
[F14:2]| 
[F14:3]| [MACRO GOAL / PROGRESS]
[F14:4]| Total tasks in project: {TOTAL_TASKS}
[F14:5]| Completed: {DONE_TASKS}/{TOTAL_TASKS}
[F14:6]| 
[F14:7]| [NEXT STEPS IN PIPELINE]
[F14:8]| {PENDING_TASKS}
[F14:9]| 
[F14:10]| [CURRENT FOCUS (CRITICAL)]
[F14:11]| The user is currently working on: "{ACTIVE_TASK}"
[F14:12]| Task details (Markdown):
[F14:13]| {TASK_DETAILS}
[F14:14]| 
[F14:15]| [INSTRUCTION]
[F14:16]| 1. Your answers MUST align with the Current Focus.
[F14:17]| 2. Use the Macro Goal and Next Steps only as background context to ensure consistency.
[F14:18]| 3. Be a minimalist. Give high-density, low-fluff code.
[F14:19]| 
[F14:20]| [MARKDOWN]
[F14:21]| If you output task `details`, you MAY use Markdown, but NEVER use `###` headings inside details (it conflicts with the user's task-ingestion format).
[F14:22]| If you need headings inside details, use `####` or deeper.

================================================================================
文件路径: task_ingest_test_cases.md(F15) (约合大小: 9 KB)
================================================================================
[F15:1]| origin: 
[F15:2]| 太好了！你已经完成了最关键的两步：
[F15:3]| 
[F15:4]| ✅ 上传了 `wwwroot.tar.gz`（站点文件）  
[F15:5]| ✅ 上传了 `backup.tar.gz`（面板备份等）
[F15:6]| 
[F15:7]| 现在你的新服务器上：
[F15:8]| - `/project/www/wwwroot.tar.gz`
[F15:9]| - `/project/www/backup.tar.gz`
[F15:10]| 
[F15:11]| 接下来，我们将**严格按照宝塔恢复逻辑 + SQLite 站点适配 PHP 7.4**，一步步完成部署。
[F15:12]| 
[F15:13]| ---
[F15:14]| 
[F15:15]| ## 🧭 后续完整操作流程（SSH 命令 + 面板操作）
[F15:16]| 
[F15:17]| > 所有命令均在 **新服务器 SSH 中执行**（以 root 身份）
[F15:18]| 
[F15:19]| ---
[F15:20]| 
[F15:21]| ### 🔹 步骤 1：安装宝塔面板（如果尚未安装）
[F15:22]| 
[F15:23]| ```bash
[F15:24]| # 检查是否已装
[F15:25]| bt -v 2>/dev/null || echo "未安装宝塔"
[F15:26]| 
[F15:27]| # 若未安装，执行官方安装（以 Ubuntu 为例）
[F15:28]| wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && bash install.sh
[F15:29]| ```
[F15:30]| 
[F15:31]| > 安装完成后，记录面板地址、用户名、密码。  
[F15:32]| > 默认路径会创建：`/www/`, `/www/server/panel/`, `/www/backup/` 等。
[F15:33]| 
[F15:34]| ---
[F15:35]| 
[F15:36]| ### 🔹 步骤 2：解压并还原你的备份
[F15:37]| 
[F15:38]| #### A. 创建标准目录（如果不存在）
[F15:39]| ```bash
[F15:40]| mkdir -p /www/wwwroot
[F15:41]| mkdir -p /www/backup/panel
[F15:42]| ```
[F15:43]| 
[F15:44]| #### B. 解压站点文件
[F15:45]| ```bash
[F15:46]| tar -xzf /project/www/wwwroot.tar.gz -C /www/wwwroot/
[F15:47]| # 确保目标是 www.cpagz.com 目录
[F15:48]| ls -la /www/wwwroot/www.cpagz.com/
[F15:49]| ```
[F15:50]| 
[F15:51]| #### C. 解压面板备份（用于恢复面板配置）
[F15:52]| ```bash
[F15:53]| tar -xzf /project/www/backup.tar.gz -C /tmp/
[F15:54]| # 假设 backup.tar.gz 内部结构为 backup/panel/*.zip
[F15:55]| cp /tmp/backup/panel/*.zip /www/backup/panel/
[F15:56]| ls -la /www/backup/panel/
[F15:57]| ```
[F15:58]| 
[F15:59]| > 💡 如果 `backup.tar.gz` 解压后不是直接含 `.zip`，请先 `ls /tmp/` 看结构，再调整路径。
[F15:60]| 
[F15:61]| ---
[F15:62]| 
[F15:63]| ### 🔹 步骤 3：恢复宝塔面板配置（使用面板备份 ZIP）
[F15:64]| 
[F15:65]| 1. **打开宝塔面板**（浏览器访问 `http://你的IP:8888` 或旧端口）
[F15:66]| 2. 进入 **「设置」→「面板设置」→「备份与恢复」**
[F15:67]|    - 或直接访问：`http://IP:8888/admin/backup`
[F15:68]| 3. 在「恢复」区域，你会看到 `/www/backup/panel/` 下的 ZIP 文件（如 `2026-01-27.zip`）
[F15:69]| 4. **点击「恢复」对应日期的最新备份**
[F15:70]| 
[F15:71]| > ✅ 此操作会恢复：
[F15:72]| > - 所有站点配置（包括域名、根目录、PHP 版本记录）
[F15:73]| > - 计划任务（crontab）
[F15:74]| > - SSL 证书信息（但需重新申请或手动放证书文件）
[F15:75]| > - 面板端口（可能恢复为 `10156`）
[F15:76]| 
[F15:77]| ⚠️ **注意**：恢复后，宝塔可能会提示“部分服务未安装”，这是正常的——我们下一步装环境。
[F15:78]| 
[F15:79]| ---
[F15:80]| 
[F15:81]| ### 🔹 步骤 4：安装运行环境（Nginx + PHP 7.4）
[F15:82]| 
[F15:83]| > 虽然面板配置恢复了“站点记录”，但底层软件（Nginx/PHP）并未安装！
[F15:84]| 
[F15:85]| 1. 进入宝塔 **「软件商店」**
[F15:86]| 2. 安装：
[F15:87]|    - **Nginx**（版本建议 1.24+）
[F15:88]|    - **PHP 7.4**（关键！不要装 5.6）
[F15:89]|      - 安装时务必勾选：`sqlite3`, `pdo_sqlite`, `gd`, `curl`, `mbstring`, `zip`
[F15:90]| 3. 等待安装完成（约 10~20 分钟）
[F15:91]| 
[F15:92]| > ✅ 安装 PHP 7.4 后，系统会自动生成：  
[F15:93]| > `/www/server/panel/vhost/nginx/enable-php-74.conf`
[F15:94]| 
[F15:95]| ---
[F15:96]| 
[F15:97]| ### 🔹 步骤 5：修正站点 PHP 版本引用（从 5.6 → 7.4）
[F15:98]| 
[F15:99]| 你的旧 Nginx 配置引用的是 `enable-php-56.conf`，必须更新！
[F15:100]| 
[F15:101]| #### 方法 A（推荐）：通过面板 UI 修改
[F15:102]| 1. 宝塔 → 「网站」→ 找到 `www.cpagz.com`
[F15:103]| 2. 点击「设置」→「PHP 版本」→ 改为 **PHP-74**
[F15:104]| 3. 保存，自动重载 Nginx
[F15:105]| 
[F15:106]| #### 方法 B（手动）：编辑 vhost 文件
[F15:107]| ```bash
[F15:108]| # 备份原配置
[F15:109]| cp /www/server/panel/vhost/nginx/www.cpagz.com.conf{,.bak}
[F15:110]| 
[F15:111]| # 替换 include 行
[F15:112]| sed -i 's/enable-php-56\.conf/enable-php-74.conf/g' /www/server/panel/vhost/nginx/www.cpagz.com.conf
[F15:113]| 
[F15:114]| # 重载 Nginx
[F15:115]| bt reload
[F15:116]| ```
[F15:117]| 
[F15:118]| > ✅ 验证：`grep enable-php /www/server/panel/vhost/nginx/www.cpagz.com.conf`
[F15:119]| 
[F15:120]| ---
[F15:121]| 
[F15:122]| ### 🔹 步骤 6：修复文件权限 & SQLite 可写性
[F15:123]| 
[F15:124]| ```bash
[F15:125]| # 确认 Web 用户（宝塔通常是 www）
[F15:126]| id www
[F15:127]| 
[F15:128]| # 修复站点属主
[F15:129]| chown -R www:www /www/wwwroot/www.cpagz.com
[F15:130]| 
[F15:131]| # 确保 SQLite 数据库可写（关键！）
[F15:132]| chmod 664 /www/wwwroot/www.cpagz.com/#dep#.db
[F15:133]| chmod 664 /www/wwwroot/www.cpagz.com/#dep#1.db
[F15:134]| chmod 664 /www/wwwroot/www.cpagz.com/#dep#2.db
[F15:135]| 
[F15:136]| # 如果程序要写日志/缓存，确保目录可写
[F15:137]| chmod -R 775 /www/wwwroot/www.cpagz.com/runtime  # 示例目录，按实际调整
[F15:138]| ```
[F15:139]| 
[F15:140]| ---
[F15:141]| 
[F15:142]| ### 🔹 步骤 7：验证 SQLite 扩展 & 站点功能
[F15:143]| 
[F15:144]| #### A. 临时创建 phpinfo 检查扩展
[F15:145]| ```bash
[F15:146]| echo '<?php phpinfo(); ?>' > /www/wwwroot/www.cpagz.com/_test.php
[F15:147]| ```
[F15:148]| 访问：`http://www.cpagz.com/_test.php`  
[F15:149]| 搜索 `sqlite3` 和 `pdo_sqlite`，确认已加载。
[F15:150]| 
[F15:151]| > ✅ 正常应看到：
[F15:152]| > - `SQLite3 support => enabled`
[F15:153]| > - `PDO drivers => sqlite`
[F15:154]| 
[F15:155]| 验证完立即删除：
[F15:156]| ```bash
[F15:157]| rm -f /www/wwwroot/www.cpagz.com/_test.php
[F15:158]| ```
[F15:159]| 
[F15:160]| #### B. 测试站点核心功能
[F15:161]| - 访问首页
[F15:162]| - 尝试登录（如有后台）
[F15:163]| - 提交一个表单（验证写入 `.db` 是否成功）
[F15:164]| 
[F15:165]| ---
[F15:166]| 
[F15:167]| ### 🔹 步骤 8：检查并清理旧 IP / 伪静态（可选）
[F15:168]| 
[F15:169]| #### A. 检查 Nginx server_name 是否含旧 IP
[F15:170]| ```bash
[F15:171]| grep "server_name" /www/server/panel/vhost/nginx/www.cpagz.com.conf
[F15:172]| ```
[F15:173]| 如果输出包含 `101.200.196.68`，建议改为：
[F15:174]| ```nginx
[F15:175]| server_name www.cpagz.com cpagz.com;
[F15:176]| ```
[F15:177]| 然后 `bt reload`
[F15:178]| 
[F15:179]| #### B. 伪静态
[F15:180]| 你的 `rewrite/www.cpagz.com.conf` 为空，说明无特殊规则。  
[F15:181]| 如有需要，可在面板「网站 → 设置 → 伪静态」中手动添加。
[F15:182]| 
[F15:183]| ---
[F15:184]| 
[F15:185]| ### 🔹 步骤 9：防火墙 & 端口放行
[F15:186]| 
[F15:187]| - 如果面板端口恢复为 `10156`，确保云服务器安全组放行 **10156**
[F15:188]| - 网站 80/443 端口也需放行
[F15:189]| 
[F15:190]| 宝塔内部放行（可选）：
[F15:191]| ```bash
[F15:192]| # 开放面板端口（如 10156）
[F15:193]| bt 19  # 然后输入 10156
[F15:194]| ```
[F15:195]| 
[F15:196]| ---
[F15:197]| 
[F15:198]| ### 🔹 步骤 10：最终验收
[F15:199]| 
[F15:200]| | 检查项 | 命令 / 操作 |
[F15:201]| |-------|-------------|
[F15:202]| | 面板可访问 | `http://IP:10156`（或 8888） |
[F15:203]| | 网站可访问 | `curl -I http://www.cpagz.com` |
[F15:204]| | PHP 7.4 + SQLite | `_test.php` 验证 |
[F15:205]| | 数据库可读写 | 提交表单，检查 `.db` 文件修改时间 |
[F15:206]| | 日志无致命错误 | `tail /www/wwwlogs/www.cpagz.com.error.log` |
[F15:207]| 
[F15:208]| ---
[F15:209]| 
[F15:210]| ## 🎉 完成！
[F15:211]| 
[F15:212]| 你现在拥有的是一个：
[F15:213]| - **基于宝塔面板管理**
[F15:214]| - **运行 PHP 7.4**
[F15:215]| - **使用 SQLite 存储数据**
[F15:216]| - **配置从旧站完整恢复**
[F15:217]| 
[F15:218]| 的现代化、可维护的新站点。
[F15:219]| 
[F15:220]| ---
[F15:221]| 
[F15:222]| ### 🔒 最后安全建议
[F15:223]| 1. 删除所有测试文件（如 `_test.php`）
[F15:224]| 2. 检查是否有 `backup/`, `test/` 目录残留（你的 tar.gz 可能包含）
[F15:225]| 3. 在面板中开启「防跨站攻击」（open_basedir）
[F15:226]| 4. 定期在宝塔中设置「自动备份」（站点 + 面板）
[F15:227]| 
[F15:228]| ---
[F15:229]| 
[F15:230]| 如果你在任一步遇到具体报错（如 500、403、数据库无法打开），请贴出：
[F15:231]| - 错误页面截图 or 文字
[F15:232]| - `error.log` 片段
[F15:233]| - `ls -la /www/wwwroot/www.cpagz.com/` 输出
[F15:234]| 
[F15:235]| 我可以帮你精准定位！
[F15:236]| 
[F15:237]| -----------
[F15:238]| raw_text_case_simple:
[F15:239]| 我今晚想把项目收尾，明天要给老板演示，所以需要先把环境搭起来，然后整理一个演示脚本，再做一次演练。别忘了把截图和日志备份到云盘，演示结束后把临时文件清理掉。
[F15:240]| 
[F15:241]| -----------
[F15:242]| after:
[F15:243]| 
[F15:244]| 
[F15:245]| 
[F15:246]| 
[F15:247]| 
[F15:248]| 
[F15:249]| 
[F15:250]| -----
[F15:251]| # Demo Project
[F15:252]| ## Phase A
[F15:253]| 
[F15:254]| ### Implement parser
[F15:255]|   Accept only ### headings as steps.
[F15:256]|   Indented lines become details.
[F15:257]| 
[F15:258]| ### Update docs
[F15:259]|   Mention the format in README.
[F15:260]| 
[F15:261]| # Markdown Rendering (Details)
[F15:262]| ## Notes
[F15:263]| - Only `###` headings become tasks.
[F15:264]| - Details lines must be indented.
[F15:265]| - In details, DO NOT use `###` headings (use `####` or deeper).
[F15:266]| 
[F15:267]| ## Rich Markdown in details
[F15:268]| 
[F15:269]| ## Expected (visual)
[F15:270]| - Details panel (Split) and active task body (Inline) should render:
[F15:271]|   - Bulleted + numbered lists with proper indentation
[F15:272]|   - Inline code with a subtle pill background
[F15:273]|   - Fenced code blocks in a dark box with horizontal scroll
[F15:274]|   - Links in accent color, underlined on hover
[F15:275]|   - `####` headings as slightly bolder text
[F15:276]| - Sanitization check:
[F15:277]|   - No alerts/popups should ever run
[F15:278]|   - The `javascript:` link should not be clickable/should have its href removed
[F15:279]|   - The `<script>` tag should not appear as executable content
[F15:280]| 
[F15:281]| ### Render lists + inline code
[F15:282]|   Here is a list:
[F15:283]|   - item one
[F15:284]|   - item two with `inline code`
[F15:285]|   - item three
[F15:286]|   
[F15:287]|   And an ordered list:
[F15:288]|   1. first
[F15:289]|   2. second
[F15:290]| 
[F15:291]| ### Render code blocks
[F15:292]|   ```js
[F15:293]|   function hello(name) {
[F15:294]|     return `hi ${name}`;
[F15:295]|   }
[F15:296]|   ```
[F15:297]|   
[F15:298]|   Inline: `const x = 1`.
[F15:299]| 
[F15:300]| ### Render links + emphasis
[F15:301]|   Visit [OpenAI](https://openai.com).
[F15:302]|   
[F15:303]|   **Bold**, *italic*, and ~~strike~~.
[F15:304]| 
[F15:305]| ### Render headings inside details (use ####)
[F15:306]|   #### Subsection
[F15:307]|   Some text under a subsection.
[F15:308]|   
[F15:309]|   #### Another subsection
[F15:310]|   - bullet under subsection
[F15:311]| 
[F15:312]| ### Sanitization check (HTML should not execute)
[F15:313]|   This should be removed or neutralized:
[F15:314]|   <script>alert('xss')</script>
[F15:315]|   <img src=x onerror=alert('xss')>
[F15:316]|   <a href="javascript:alert('xss')">bad link</a>
[F15:317]|   
[F15:318]|   This should remain as normal Markdown:
[F15:319]|   - `code`
[F15:320]|   - [safe link](https://example.com)
[F15:321]| 
[F15:322]| # Demo
[F15:323]| ## Phase A
[F15:324]| ### Step A1
[F15:325]|   detail A1
[F15:326]| ## Phase B
[F15:327]| ### Step B1
[F15:328]|   detail B1
[F15:329]| 
[F15:330]| # Doc A
[F15:331]| ### Step 1
[F15:332]|   a
[F15:333]| # Doc B
[F15:334]| ### Step 2
[F15:335]|   b

================================================================================
文件路径: test.md(F16) (约合大小: 2 KB)
================================================================================
[F16:1]| 
[F16:2]| ### 1. 部署到 Chrome 侧边栏 (首选验证方式)
[F16:3]| 
[F16:4]| 1.  **修正加载路径**：
[F16:5]|     在您的 `README.md` `[F4:19]` 中写的是“选择 `github` 文件夹”，但在当前的源码结构中，`manifest.json` `[F1]` 位于**根目录**。
[F16:6]|     *   **操作**：在 `chrome://extensions/` 点击“加载已解压的扩展程序”时，请选择**整个项目所在的根文件夹**。
[F16:7]| 2.  **唤起侧边栏**：
[F16:8]|     *   点击 Chrome 右上角的“扩展程序”图标（拼图形状）。
[F16:9]|     *   找到 **Rail** 并点击。如果它没直接打开侧边栏，请查看地址栏右侧是否有 Rail 的小图标，点击它。
[F16:10]| 
[F16:11]| ---
[F16:12]| 
[F16:13]| ### 2. 基础功能验收清单 (3 分钟)
[F16:14]| 
[F16:15]| 请按以下顺序操作，验证 `script.js` `[F5]` 的核心逻辑：
[F16:16]| 
[F16:17]| *   **[ ] 任务录入 (Ingestion)**：
[F16:18]|     在输入框粘贴以下内容并点击 **Add Tasks**：
[F16:19]|     ```text
[F16:20]|     - [ ] 验证 API 连接性
[F16:21]|     1. 测试任务切换逻辑
[F16:22]|     * 检查本地存储是否持久化
[F16:23]|     ```
[F16:24]|     *验证点*：`[F5:165-168]` 的正则逻辑应自动删掉前缀，列表里只显示“验证 API 连接性”等干净的文本。
[F16:25]| 
[F16:26]| *   **[ ] 状态切换 (Task Toggle)**：
[F16:27]|     点击第一个任务。
[F16:28]|     *验证点*：该任务应变为“蓝色高亮”（Active）`[F8:102]`。再次点击，它应变灰并带中划线（Done）`[F8:107]`。
[F16:29]| 
[F16:30]| *   **[ ] 配置保存 (Settings)**：
[F16:31]|     点击右上角齿轮 `9ed`，输入 API Key、Base URL 和 Model，点击 **Save Settings**。
[F16:32]|     *验证点*：刷新页面，配置信息应该依然存在（`localStorage` 持久化验证 `[F5:188]`）。
[F16:33]| 
[F16:34]| *   **[ ] 基础对话 (Chat)**：
[F16:35]|     选中一个任务，在对话框输入 `你好，该任务的重点是什么？`。
[F16:36]|     *验证点*：
[F16:37]|     1. 状态栏显示 `Thinking...` `[F5:290]`。
[F16:38]|     2. API 返回结果。
[F16:39]|     3. AI 的回复中，代码部分应能正常换行（CSS `pre-wrap` 验证 `[F8:209]`）。
[F16:40]| 
[F16:41]| ---
[F16:42]| 
[F16:43]| ### 3. 给您的调试小贴士
[F16:44]| 
[F16:45]| 由于扩展程序的侧边栏调试稍微隐蔽一点：
[F16:46]| 1.  在侧边栏的空白处**右键 -> 检查 (Inspect)**。
[F16:47]| 2.  这会打开侧边栏专属的开发者工具。
[F16:48]| 3.  在 **Console** 面板，您可以看到 `script.js` 发出的所有错误。如果 API 调用失败，报错信息会在这里显示（例如 `401 Unauthorized` 或网络跨域问题）。

================================================================================
文件路径: todo.md(F17) (约合大小: 1 KB)
================================================================================
[F17:1]| # Rail 迭代计划 (V0.2.1 - Intelligence & HUD Focus)
[F17:2]| 
[F17:3]| ## 1. AI 上下文进阶 (Intelligence)
[F17:4]| - [ ] **项目全局记事本 (Global Context)**：
[F17:5]|     - 增加一个持久化的“项目全局记事本”设置。
[F17:6]|     - 在 `buildSystemPrompt` 中注入 `{PROJECT_CONTEXT}` 变量。
[F17:7]|     - 允许存放通用规则（如：编码规范、架构约束）。 * 暂时不加入，保持轻量
[F17:8]| 
[F17:9]| ## 2. 交互与动效 (Interactions & Animations)
[F17:10]| - [ ] **任务完成微动画**：点击完成时增加复选框缩放及删除线平滑划过效果。
[F17:11]| - [ ] **页面平滑切换**：主页、编辑器、设置页切换时增加淡入淡出或位移过渡。
[F17:12]| - [ ] **活跃任务视觉引导**：在当前任务左侧增加动态的“活动条”指示器。
[F17:13]| - [ ] **空状态美化**：优化无任务/无配置时的显示，增加引导性操作指引。
[F17:14]| 
[F17:15]| ## 3. 代码质量与重构 (Refactoring & Quality)
[F17:16]| - [ ] **存储抽象**：将 `localStorage` 操作封装为统一的存储服务，为未来切换到 `chrome.storage` 做准备。
[F17:17]| - [ ] **样式模块化**：整理 `styles.css`，采用更规范的 BEM 或变量管理方式。

--------------------------------------------------------------------------------
文件路径: todolist_get.txt(F18) (约合大小: 1 KB)
--------------------------------------------------------------------------------
[F18:1]| 你是“Rail 任务注入格式转换器（高保真）”。你的唯一输出必须是 Rail 可解析的 Markdown，用于直接粘贴到 Rail 的任务输入框。
[F18:2]| 
[F18:3]| 【Rail 解析格式（必须严格遵守）】
[F18:4]| 
[F18:5]| 允许的行类型只有：
[F18:6]| #  文档标题（可选，最多 1 行）
[F18:7]| ##  分组标题（可选，多行）
[F18:8]| ###  任务步骤（必须，1 行=1 步）
[F18:9]| 任务步骤下面的 details：必须是“缩进的普通行”（每行前至少 2 个空格或 1 个 Tab）
[F18:10]| 除上述四类行，禁止输出任何解释/前后缀/免责声明。
[F18:11]| Details 中严禁出现以 ### 开头的行（会触发 Rail 误解析）；若原文有标题层级，请改写为普通句子或用 ####（注意：#### 是允许的）。
[F18:12]| 允许在 details 中使用 Markdown（包括列表、链接、加粗、以及 fenced code blocks），但 fenced code block 的每一行（含 ```）都必须缩进。
[F18:13]| 【高保真（最重要）】
[F18:14]| 
[F18:15]| 所有命令/代码/路径/端口/域名/IP/文件名/配置片段：必须尽量原样保留，不得改写为概述。
[F18:16]| 不要“智能总结”替换原始命令；如果原文给了命令，就把命令放进对应步骤的 details。
[F18:17]| 如果原文包含“方法 A / 方法 B / 可选 / 推荐”，请保留为 details（不要拆成新的 ###，除非它们本身就是独立步骤）。
[F18:18]| 【是否为 ToDoList 的判定】
[F18:19]| 若输入包含多步操作、清单、编号、项目符号、或明显“步骤/流程/待办”，判定为 ToDoList。
[F18:20]| 否则输出固定一行：NOT_A_TODOLIST
[F18:21]| 
[F18:22]| 【输出要求】
[F18:23]| 
[F18:24]| 若 ToDoList：只输出 Rail Markdown（按上面规则）
[F18:25]| 若非 ToDoList：只输出 NOT_A_TODOLIST
[F18:26]| 【输入】
[F18:27]| <<<INPUT
[F18:28]| （把原文粘贴在这里）
[F18:29]| INPUT
[F18:30]| 
[F18:31]| 【开始】
[F18:32]| 现在直接输出。

================================================================================
文件路径: vercel.json(F19) (约合大小: 0 KB)
================================================================================
[F19:1]| {
[F19:2]|   "rewrites": [
[F19:3]|     {
[F19:4]|       "source": "/",
[F19:5]|       "destination": "/sidepanel.html"
[F19:6]|     }
[F19:7]|   ]
[F19:8]| }

================================================================================
文件路径: github\copilotrule.md(F20) (约合大小: 2 KB)
================================================================================
[F20:1]| # Project Rail - AI Instructions
[F20:2]| 
[F20:3]| ## 1. Project Identity
[F20:4]| You are the lead developer for "Rail", a Chrome Extension designed to be a "Context Anchor" and "Execution GPS" for developers.
[F20:5]| - **Core Philosophy**: Minimalist, Dark Mode, Local-First, One-Time Use (Disposable).
[F20:6]| - **Tech Stack**: Vanilla JS (ES6+), HTML5, CSS3 (Flexbox), Chrome Extension Manifest V3. No React/Vue/Bundlers for the MVP.
[F20:7]| 
[F20:8]| ## 2. Architecture & Files
[F20:9]| - **manifest.json**: Needs `sidePanel`, `activeTab`, `scripting`, `storage` permissions.
[F20:10]| - **sidepanel.html**: The main UI.
[F20:11]|   - Top 60%: Task List (Scrollable).
[F20:12]|   - Bottom 40%: Chat Interface (Fixed).
[F20:13]| - **styles.css**: VS Code-like Dark Mode theme. Colors: Bg `#1e1e1e`, Accent `#3b82f6`.
[F20:14]| - **script.js**: Contains all logic for DOM manipulation, LocalStorage, and API calls.
[F20:15]| 
[F20:16]| ## 3. Core Features (The "Must-Haves")
[F20:17]| ### A. Task List Logic
[F20:18]| - **Data Structure**: Array of objects `{ id, text, status: 'pending'|'done', context_payload: {} }`.
[F20:19]| - **Interaction**: Click to toggle done/active.
[F20:20]| - **Smart Ingestion**: 
[F20:21]|   - Allow users to paste raw text.
[F20:22]|   - **Rule**: If raw text is pasted, simply split by newlines for the MVP (or call LLM if API key is present).
[F20:23]| 
[F20:24]| ### B. Chat & Context (BYOK)
[F20:25]| - **Settings**: Store OpenAI API Key & Base URL in `localStorage`.
[F20:26]| - **Context Injection**: When user asks a question in the chat input:
[F20:27]|   1. Grab the currently **Active** task text.
[F20:28]|   2. Grab the User's question.
[F20:29]|   3. Construct System Prompt: "You are an execution assistant. Context Task: [Active Task]..."
[F20:30]|   4. Call API (`POST /v1/chat/completions`).
[F20:31]| 
[F20:32]| ## 4. Coding Standards (Strict)
[F20:33]| - **Error Handling**: Always check if API Key exists before calling API. Alert user if missing.
[F20:34]| - **UI Feedback**: Show a loading spinner or text when waiting for API response.
[F20:35]| - **Clean Code**: Keep logic in `script.js`. Use readable variable names. Comments are required for complex logic.
[F20:36]| 
[F20:37]| ## 5. Tone & Style
[F20:38]| - Be concise.
[F20:39]| - Focus on shipping working code.
[F20:40]| - If I ask for a feature, implement it directly in the existing file structure.

## 统计信息
- 包含文件数: 20
- 总大小: 129 KB